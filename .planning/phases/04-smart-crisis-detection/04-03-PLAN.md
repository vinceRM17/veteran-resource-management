---
phase: 04-smart-crisis-detection
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/admin/crisis-monitoring/page.tsx
  - src/app/admin/crisis-monitoring/review-action.ts
  - src/app/admin/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Monitoring dashboard shows recent crisis detection events ordered by most recent first"
    - "New crisis detections appear in real-time via Supabase Realtime subscription"
    - "Unreviewed events are visually distinct from reviewed events"
    - "Reviewer can mark an event as reviewed with false positive flag and notes"
    - "Dashboard shows key stats: total detections, unreviewed count, false positive rate"
  artifacts:
    - path: "src/app/admin/crisis-monitoring/page.tsx"
      provides: "Real-time crisis monitoring dashboard page"
      min_lines: 80
    - path: "src/app/admin/crisis-monitoring/review-action.ts"
      provides: "Server action for marking crisis logs as reviewed"
      exports: ["reviewCrisisLog"]
    - path: "src/app/admin/layout.tsx"
      provides: "Admin layout wrapper"
      min_lines: 10
  key_links:
    - from: "src/app/admin/crisis-monitoring/page.tsx"
      to: "supabase/migrations/00006_crisis_detection.sql"
      via: "queries crisis_detection_logs table and subscribes to realtime changes"
      pattern: "from.*crisis_detection_logs"
    - from: "src/app/admin/crisis-monitoring/review-action.ts"
      to: "supabase/migrations/00006_crisis_detection.sql"
      via: "updates crisis_detection_logs with review data"
      pattern: "from.*crisis_detection_logs.*update"
---

<objective>
Build the crisis detection monitoring dashboard with real-time alerts and human review workflow.

Purpose: Automated crisis detection is not sufficient on its own — human review is essential for identifying false positives, refining keyword lists, and ensuring no crisis event goes unnoticed. This dashboard enables a 24/7 monitoring team to see new detections in real-time, review them, and flag false positives.

Output: Admin monitoring dashboard page with Supabase Realtime subscription, server action for marking logs as reviewed.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-crisis-detection/04-RESEARCH.md
@.planning/phases/04-smart-crisis-detection/04-01-SUMMARY.md

# Existing patterns
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout and crisis monitoring dashboard with real-time updates</name>
  <files>
    src/app/admin/layout.tsx
    src/app/admin/crisis-monitoring/page.tsx
  </files>
  <action>
    **Admin layout** (`src/app/admin/layout.tsx`):

    Create a simple server component layout wrapper for admin pages:
    1. Import MainLayout or similar pattern from existing layout
    2. Add a banner/header indicating "Admin Dashboard" area
    3. Minimal styling — this is a monitoring tool, not a public page
    4. Include a note/comment that auth protection for admin routes should be added in Phase 5 when user roles exist

    **Crisis monitoring dashboard** (`src/app/admin/crisis-monitoring/page.tsx`):

    Create a "use client" page component:

    **State:**
    - `recentLogs: CrisisLogEntry[]` — array of crisis log entries
    - `isLoading: boolean` — initial load state
    - `stats: { total: number; unreviewed: number; falsePositiveRate: number }` — summary stats
    - `expandedLogId: string | null` — which log entry has expanded review form

    **Initial data fetch (useEffect):**
    1. Create Supabase browser client via `createClient()` from `@/lib/supabase/client`
    2. Query crisis_detection_logs ordered by detected_at DESC, limit 50
    3. Compute stats from the fetched data:
       - total: count of all rows
       - unreviewed: count where reviewed_at is null
       - falsePositiveRate: count of is_false_positive=true / count of reviewed rows (avoid divide by zero)
    4. Set recentLogs and stats

    **Real-time subscription (useEffect):**
    1. Subscribe to `postgres_changes` on `crisis_detection_logs` table for INSERT events
    2. On new insert: prepend to recentLogs, increment stats.total and stats.unreviewed
    3. Also subscribe to UPDATE events (for when logs are reviewed)
    4. On update: replace the updated log in recentLogs, recompute stats
    5. Clean up subscription on unmount: `supabase.removeChannel(channel)`

    **UI layout:**

    1. **Header section:**
       - h1: "Crisis Detection Monitoring"
       - Description: "Real-time monitoring of crisis keyword detections during screening. Review each event and mark false positives."

    2. **Stats bar** (3 cards in a row):
       - Total detections (number, neutral color)
       - Needs review (number, red background if > 0, green if 0)
       - False positive rate (percentage, shows "N/A" if no reviews yet)

    3. **Log list:**
       - Each log entry as a card with:
         - Detected at timestamp (formatted with toLocaleString)
         - Keywords as colored badges (red for high severity, yellow for medium)
         - Max severity indicator
         - Review status: "Needs Review" (red badge) or "Reviewed" (green badge) or "False Positive" (gray badge)
       - Unreviewed entries have red-50 background, reviewed have white/gray-50
       - Click on a log card toggles expandedLogId to show review form inline

    4. **Inline review form** (shown when expandedLogId matches):
       - Checkbox: "Mark as false positive"
       - Textarea: "Review notes" (optional)
       - Submit button: "Mark as Reviewed"
       - Calls reviewCrisisLog server action with the log id, is_false_positive, and notes
       - On success: collapse the form, update the log in local state

    5. **Empty state:**
       - If no logs: "No crisis detections recorded yet. Events will appear here in real-time."

    6. **Loading state:**
       - Show skeleton/loading indicator while initial fetch is in progress

    Use Tailwind classes consistent with the project's existing style. Import Card, CardContent, CardHeader, CardTitle from @/components/ui/card if they exist. Otherwise use plain divs with Tailwind.

    Type the CrisisLogEntry import from `@/lib/crisis/types`.
  </action>
  <verify>
    - Admin layout exists at src/app/admin/layout.tsx
    - Dashboard page exists at src/app/admin/crisis-monitoring/page.tsx
    - Page queries crisis_detection_logs on mount
    - Page subscribes to Supabase Realtime for INSERT and UPDATE events
    - Stats bar shows total, unreviewed, and false positive rate
    - Each log entry shows keywords, severity, timestamp, and review status
    - Inline review form appears when clicking a log entry
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    Crisis monitoring dashboard shows real-time crisis detection events with stats summary. Unreviewed events are visually prominent. Each event is expandable with inline review form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server action for crisis log review workflow</name>
  <files>
    src/app/admin/crisis-monitoring/review-action.ts
  </files>
  <action>
    Create a "use server" module with the review action:

    **`reviewCrisisLog` server action:**

    ```typescript
    export async function reviewCrisisLog(params: {
      logId: string;
      isFalsePositive: boolean;
      notes?: string;
    }): Promise<{ success: boolean; error?: string }>
    ```

    Implementation:
    1. Import createClient from `@/lib/supabase/server`
    2. Get current user with `supabase.auth.getUser()` — reviewer must be authenticated
    3. If no user, return `{ success: false, error: "Authentication required" }`
    4. Update crisis_detection_logs row:
       ```typescript
       const { error } = await supabase
         .from("crisis_detection_logs")
         .update({
           reviewed_by: user.id,
           reviewed_at: new Date().toISOString(),
           is_false_positive: params.isFalsePositive,
           review_notes: params.notes || null,
         })
         .eq("id", params.logId);
       ```
    5. If error, return `{ success: false, error: "Failed to update review" }`
    6. Return `{ success: true }`

    Include input validation:
    - logId must be a non-empty string
    - notes must be under 2000 characters if provided
    - Use Zod for validation (already in project dependencies)
  </action>
  <verify>
    - Server action file exists at src/app/admin/crisis-monitoring/review-action.ts
    - Exports reviewCrisisLog function
    - Validates that user is authenticated before allowing review
    - Updates the correct crisis_detection_logs row with reviewer info
    - Input validation with Zod
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    Review workflow enables authenticated users to mark crisis logs as reviewed, flag false positives, and add notes. Server action validates authentication and input before updating database.
  </done>
</task>

</tasks>

<verification>
- Dashboard loads and displays crisis detection logs
- Real-time subscription receives new crisis events
- Stats bar correctly counts total, unreviewed, and false positive rate
- Review action updates database with reviewer info
- Unreviewed and reviewed events are visually distinct
- Empty state shows helpful message
</verification>

<success_criteria>
- /admin/crisis-monitoring page renders with stats and log list
- New crisis detections appear in real-time without page refresh
- Clicking a log entry shows inline review form
- Submitting review marks the log as reviewed in database
- False positive flag is tracked for future keyword refinement
- Dashboard is functional (not blocked by missing auth — auth comes in Phase 5)
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-crisis-detection/04-03-SUMMARY.md`
</output>
