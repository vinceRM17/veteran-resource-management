---
phase: 03-core-screening-eligibility-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/screening/store.ts
  - src/app/screening/page.tsx
  - src/app/screening/intake/layout.tsx
  - src/app/screening/intake/step-1/page.tsx
  - src/app/screening/intake/step-2/page.tsx
  - src/app/screening/intake/step-3/page.tsx
  - src/app/screening/intake/step-4/page.tsx
  - src/app/screening/intake/review/page.tsx
  - src/components/screening/StepIndicator.tsx
  - src/components/screening/QuestionCard.tsx
  - src/components/screening/ConditionalField.tsx
  - src/components/layout/Header.tsx
autonomous: true

must_haves:
  truths:
    - "User can start screening from /screening landing page"
    - "User selects role (veteran or caregiver) on step 1"
    - "User sees role-appropriate questions with conditional fields showing/hiding"
    - "User can navigate forward and backward through steps"
    - "User can close browser and resume from same step when returning"
    - "User sees progress indicator showing current step"
    - "User can review all answers before submitting"
    - "Caregiver-specific questions appear only for caregiver role"
  artifacts:
    - path: "src/lib/screening/store.ts"
      provides: "Zustand store with localStorage persist for screening state"
      exports: ["useScreeningStore"]
    - path: "src/app/screening/page.tsx"
      provides: "Screening landing page with start button"
    - path: "src/app/screening/intake/layout.tsx"
      provides: "Multi-step layout with StepIndicator"
    - path: "src/app/screening/intake/step-1/page.tsx"
      provides: "Role selection step"
    - path: "src/app/screening/intake/step-2/page.tsx"
      provides: "Service and demographics step"
    - path: "src/app/screening/intake/step-3/page.tsx"
      provides: "Needs assessment step"
    - path: "src/app/screening/intake/step-4/page.tsx"
      provides: "Benefits and priorities step"
    - path: "src/app/screening/intake/review/page.tsx"
      provides: "Review answers and submit step"
    - path: "src/components/screening/StepIndicator.tsx"
      provides: "Visual progress indicator for multi-step form"
    - path: "src/components/screening/ConditionalField.tsx"
      provides: "Component that shows/hides children based on screening answers"
  key_links:
    - from: "src/app/screening/intake/step-*/page.tsx"
      to: "src/lib/screening/store.ts"
      via: "useScreeningStore hook for reading/writing answers"
      pattern: "useScreeningStore"
    - from: "src/lib/screening/store.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist.*screening-session"
    - from: "src/components/screening/ConditionalField.tsx"
      to: "src/lib/screening/conditional-logic.ts"
      via: "shouldShowField function"
      pattern: "shouldShowField"
    - from: "src/app/screening/intake/step-*/page.tsx"
      to: "src/lib/screening/schemas.ts"
      via: "Zod schema validation before advancing"
      pattern: "stepSchemas|step\\dSchema"
---

<objective>
Build the complete multi-step screening questionnaire UI with Zustand-powered session persistence, conditional field visibility, per-step validation, and progress tracking.

Purpose: This is the core user experience -- veterans and caregivers answer screening questions to get matched to programs. The form must feel simple (5 steps), be resumable (localStorage persistence), and adapt based on answers (conditional logic).

Output: Full screening flow from landing page through review, with navigation, persistence, validation, and conditional fields.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-screening-eligibility-engine/03-RESEARCH.md
@.planning/phases/03-core-screening-eligibility-engine/03-01-SUMMARY.md
@src/content/screening-questions.ts
@src/lib/screening/schemas.ts
@src/lib/screening/conditional-logic.ts
@src/lib/db/screening-types.ts
@src/components/ui/button.tsx
@src/components/ui/card.tsx
@src/components/ui/input.tsx
@src/components/ui/select.tsx
@src/components/ui/label.tsx
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand screening store with localStorage persistence and screening components</name>
  <files>
    src/lib/screening/store.ts
    src/components/screening/StepIndicator.tsx
    src/components/screening/QuestionCard.tsx
    src/components/screening/ConditionalField.tsx
  </files>
  <action>
**Zustand Store (`src/lib/screening/store.ts`):**

Create screening store using Zustand persist middleware for localStorage persistence (SCREEN-09). Follow the hasHydrated pattern from research to avoid React hydration mismatches (Pitfall 5).

Store shape:
```typescript
interface ScreeningState {
  // State
  currentStep: number
  answers: Record<string, any>
  isSubmitting: boolean
  hasHydrated: boolean

  // Actions
  setAnswer: (key: string, value: any) => void
  setAnswers: (updates: Record<string, any>) => void
  nextStep: () => void
  prevStep: () => void
  goToStep: (step: number) => void
  reset: () => void
  setSubmitting: (v: boolean) => void
  setHasHydrated: (v: boolean) => void
}
```

Key implementation details:
- Use `persist` middleware with name 'vrm-screening-session' (unique localStorage key)
- `partialize` to only persist: currentStep, answers (not isSubmitting, hasHydrated)
- `onRehydrateStorage` callback sets hasHydrated to true
- `setAnswer` must call `clearDependentFields` from conditional-logic.ts when setting conditional trigger fields (role, hasServiceConnectedDisability, isCaregiver) to prevent orphaned state (Pitfall 2)
- `TOTAL_STEPS` imported from screening-questions.ts to cap nextStep
- Export `useScreeningStore` hook

**StepIndicator (`src/components/screening/StepIndicator.tsx`):**

Visual progress bar showing steps 1-5 with labels. Props: currentStep (number), totalSteps (number).

- Each step shows: step number in circle, step label below
- Current step: highlighted (primary color, bold)
- Completed steps: check mark, green
- Future steps: gray, dimmed
- Use Tailwind for styling, flex layout
- Labels: "Role", "About You", "Your Needs", "Benefits", "Review"
- Must be accessible: aria-current="step" on current, aria-label on each step
- Responsive: hide labels on mobile (show only circles), full labels on md+

**QuestionCard (`src/components/screening/QuestionCard.tsx`):**

Reusable question wrapper component. Props: label (string), helpText (string, optional), required (boolean), error (string, optional), children (ReactNode).

- Renders as a Card component from shadcn/ui
- Label as heading (h3) with required indicator
- Help text in muted color below label
- Error message in red with role="alert" and aria-live="assertive"
- Children slot for the actual input/radio/select/checkbox

**ConditionalField (`src/components/screening/ConditionalField.tsx`):**

Component that wraps children and shows/hides based on screening store answers. Props: fieldId (string), children (ReactNode).

- Reads answers from useScreeningStore
- Calls shouldShowField(fieldId, answers) from conditional-logic.ts
- Returns null if not visible, renders children if visible
- Wraps in a div with `data-field-id={fieldId}` for testing
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles. Verify store exports useScreeningStore. Verify StepIndicator renders with aria attributes. Verify ConditionalField imports shouldShowField correctly.
  </verify>
  <done>
Zustand store persists screening answers to localStorage with hydration safety. StepIndicator shows visual progress with accessibility markup. QuestionCard provides consistent question layout. ConditionalField shows/hides content based on answer state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build 5-step screening intake pages with validation and review</name>
  <files>
    src/app/screening/page.tsx
    src/app/screening/intake/layout.tsx
    src/app/screening/intake/step-1/page.tsx
    src/app/screening/intake/step-2/page.tsx
    src/app/screening/intake/step-3/page.tsx
    src/app/screening/intake/step-4/page.tsx
    src/app/screening/intake/review/page.tsx
    src/components/layout/Header.tsx
  </files>
  <action>
**Screening Landing Page (`src/app/screening/page.tsx`):**

Server Component. Simple landing page with:
- Heading: "Find Benefits You May Qualify For"
- Subheading: "Answer a few questions to see which programs can help you. No account needed."
- "Start Screening" button linking to /screening/intake/step-1
- Brief description of what happens: "Takes about 3-5 minutes. Your answers stay on your device."
- Note about privacy: "We do not store your personal information without your consent."

**Intake Layout (`src/app/screening/intake/layout.tsx`):**

Client Component ('use client'). Wraps all step pages.
- Renders StepIndicator at top with currentStep from useScreeningStore
- Must handle hydration: show loading skeleton until hasHydrated is true (Pitfall 5)
- Contains the children (step pages)
- Max width container (max-w-2xl mx-auto) for comfortable reading

**Step 1 - Role Selection (`src/app/screening/intake/step-1/page.tsx`):**

Client Component. SCREEN-02: Role selection with two large clickable cards:
- "I am a veteran" card with brief description
- "I am supporting a veteran" card (maps to role='caregiver')
- Use Card components styled as large radio buttons (click to select, visual selected state)
- On selection, store answer via setAnswer('role', value)
- Validate with step1Schema before navigating to step-2
- "Next" button at bottom (disabled until role selected)

**Step 2 - Service & Demographics (`src/app/screening/intake/step-2/page.tsx`):**

Client Component. Uses QuestionCard for each question and ConditionalField for conditional questions.
- State selection (Select component, pre-populated with US states, default Kentucky)
- Age range (radio group: 18-34, 35-49, 50-64, 65+)
- Service era (ConditionalField for role=veteran): radio group (Vietnam era, Gulf War, Post-9/11, Other)
- Caregiver status (ConditionalField for role=caregiver): "Are you the primary caregiver?" (Yes/No)
- "Back" and "Next" buttons
- Validate with step2Schema before advancing
- Pre-fill from store answers (resume support)

**Step 3 - Needs Assessment (`src/app/screening/intake/step-3/page.tsx`):**

Client Component. SCREEN-03: Conditional logic demonstration.
- Service-connected disability (ConditionalField for role=veteran): Yes / No / Not sure
- Disability rating (ConditionalField for hasServiceConnectedDisability=yes): Select with rating ranges
- Employment status: radio group (Employed full-time, Part-time, Not employed - looking, Not employed - not looking, Retired)
- Household income: radio group with income ranges
- "Back" and "Next" buttons
- Validate with step3Schema before advancing
- Pre-fill from store answers

**Step 4 - Benefits & Priorities (`src/app/screening/intake/step-4/page.tsx`):**

Client Component. SCREEN-07: Caregiver-specific content surfaces here.
- "Which areas do you need help with?" (checkbox group, multi-select)
  - Options: Healthcare, Disability pay, Food help, Housing, Jobs, Education, Mental health
  - "Caregiver support" option: wrapped in ConditionalField (show when role=caregiver OR isCaregiver=yes)
- "Do you already get any of these benefits?" (checkbox group, multi-select)
  - Options: VA healthcare, VA disability pay, Medicaid, SNAP/food stamps, SSI, SSDI, None of these
- "Back" and "Next" buttons (Next goes to review)
- Validate with step4Schema before advancing
- Pre-fill from store answers

**Review Page (`src/app/screening/intake/review/page.tsx`):**

Client Component. SCREEN-01: Completes the multi-step flow.
- Display all answers in readable format, organized by step
- Each section has "Edit" link back to that step (e.g., "Edit" next to Role goes to /screening/intake/step-1)
- "Submit" button at bottom (will be wired to server action in Plan 03)
- For now, Submit button can show alert("Submission will be connected in next plan") or navigate to a placeholder
- Mark this page as step 5 in the store

**Header Update (`src/components/layout/Header.tsx`):**

Add "Screening" link to the header navigation, between Directory links and other navigation. Link to /screening.

**Important implementation notes:**
- All step pages must read initial values from useScreeningStore on mount and pre-fill form inputs
- Use React's useState for local form state, sync to Zustand store on "Next" click (not on every keystroke)
- Each step page should call goToStep(N) on mount to keep store.currentStep in sync with URL
- Handle direct URL navigation: if user navigates to /screening/intake/step-3 but step 1 is incomplete, redirect to step-1
- Do NOT use React Hook Form (research recommendation: keep it simple with controlled inputs + Zustand)
- All labels and help text must be at 6th-8th grade reading level (SCREEN-08)
- All form inputs need proper labels (not just placeholders), aria-required, aria-describedby for errors
  </action>
  <verify>
Run `npm run build` to verify all pages compile. Navigate through all 5 steps manually: /screening -> /screening/intake/step-1 -> step-2 -> step-3 -> step-4 -> review. Verify conditional fields show/hide correctly when changing role. Verify refreshing a step page restores answers from localStorage.
  </verify>
  <done>
Complete 5-step screening flow accessible from /screening. Role selection adapts subsequent questions. Conditional fields show/hide based on answers. Answers persist in localStorage across page refresh and browser close. Step indicator shows progress. Review page displays all answers with edit links. Header includes Screening navigation link.
  </done>
</task>

</tasks>

<verification>
- [ ] /screening landing page loads with start button
- [ ] Step 1 shows role selection cards
- [ ] Selecting "veteran" shows service era on step 2, hides caregiver question
- [ ] Selecting "caregiver" shows caregiver question on step 2, hides service era
- [ ] Disability rating appears only when "Yes" selected for service-connected disability
- [ ] Caregiver support option appears in step 4 when role=caregiver
- [ ] Closing browser and reopening resumes at correct step with answers preserved
- [ ] Back/Next navigation works through all steps
- [ ] Review page shows all answers with edit links
- [ ] Step indicator correctly highlights current step
- [ ] All form labels visible (no placeholder-only inputs)
- [ ] `npm run build` passes
</verification>

<success_criteria>
- All 5 screening steps navigable with proper validation
- Conditional logic correctly shows/hides 4+ conditional fields
- LocalStorage persistence survives browser close and reopen
- No hydration mismatch errors in console
- Screening link visible in site header
- All content at plain language reading level
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-screening-eligibility-engine/03-02-SUMMARY.md`
</output>
