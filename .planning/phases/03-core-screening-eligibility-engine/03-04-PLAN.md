---
phase: 03-core-screening-eligibility-engine
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/app/screening/actions.ts
  - src/app/screening/results/[sessionId]/page.tsx
  - src/app/screening/intake/review/page.tsx
  - src/lib/pdf/screening-results.tsx
  - src/app/screening/results/[sessionId]/pdf-download.tsx
  - supabase/migrations/00005_screening_rls_update.sql
autonomous: false

must_haves:
  truths:
    - "User submits screening and gets redirected to results page with ranked program matches"
    - "Results page shows programs grouped by confidence with documents and next steps"
    - "User can download results as PDF"
    - "Guest users can submit screening without an account"
    - "Screening session and results are saved to database"
  artifacts:
    - path: "src/app/screening/actions.ts"
      provides: "Server action that submits screening, runs eligibility engine, saves results"
      exports: ["submitScreening"]
    - path: "src/app/screening/results/[sessionId]/page.tsx"
      provides: "Results page displaying matched programs with confidence, docs, next steps"
    - path: "src/lib/pdf/screening-results.tsx"
      provides: "React PDF document component for downloadable results"
    - path: "src/app/screening/results/[sessionId]/pdf-download.tsx"
      provides: "Client component with PDFDownloadLink for browser-side PDF generation"
    - path: "supabase/migrations/00005_screening_rls_update.sql"
      provides: "Updated RLS policies for guest screening session access"
  key_links:
    - from: "src/app/screening/intake/review/page.tsx"
      to: "src/app/screening/actions.ts"
      via: "Form submission calling submitScreening server action"
      pattern: "submitScreening"
    - from: "src/app/screening/actions.ts"
      to: "src/lib/eligibility/engine.ts"
      via: "evaluateEligibility called with answers and loaded rules"
      pattern: "evaluateEligibility"
    - from: "src/app/screening/actions.ts"
      to: "src/lib/eligibility/rules-loader.ts"
      via: "loadActiveRules called for jurisdiction"
      pattern: "loadActiveRules"
    - from: "src/app/screening/results/[sessionId]/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Fetches screening results by session ID"
      pattern: "supabase.*screening_results"
    - from: "src/app/screening/results/[sessionId]/pdf-download.tsx"
      to: "src/lib/pdf/screening-results.tsx"
      via: "PDFDownloadLink renders ScreeningResultsPDF document"
      pattern: "PDFDownloadLink.*ScreeningResultsPDF"
---

<objective>
Wire the screening form submission to the eligibility engine, build the results display page, add PDF export capability, and update RLS policies for guest access.

Purpose: This plan connects all the pieces -- form submission triggers eligibility evaluation, results are saved and displayed, and users can take results with them as PDF. This completes the end-to-end screening flow that is the core value of the platform.

Output: Working end-to-end screening flow: submit answers -> evaluate eligibility -> view results -> download PDF. Plus RLS policy updates for guest users.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-screening-eligibility-engine/03-RESEARCH.md
@.planning/phases/03-core-screening-eligibility-engine/03-01-SUMMARY.md
@.planning/phases/03-core-screening-eligibility-engine/03-02-SUMMARY.md
@.planning/phases/03-core-screening-eligibility-engine/03-03-SUMMARY.md
@src/lib/eligibility/engine.ts
@src/lib/eligibility/rules-loader.ts
@src/lib/eligibility/confidence-scorer.ts
@src/lib/screening/store.ts
@src/app/screening/intake/review/page.tsx
@src/content/documentation-checklists.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submission server action, results page, and RLS policy updates</name>
  <files>
    src/app/screening/actions.ts
    src/app/screening/results/[sessionId]/page.tsx
    src/app/screening/intake/review/page.tsx
    supabase/migrations/00005_screening_rls_update.sql
  </files>
  <action>
**Server Action (`src/app/screening/actions.ts`):**

Create 'use server' module with submitScreening function.

```typescript
export async function submitScreening(answers: Record<string, any>): Promise<{
  sessionId?: string
  error?: string
}>
```

Implementation:
1. Create Supabase server client
2. Validate that answers contain required fields (role, state at minimum)
3. Determine jurisdiction from answers.state (default 'kentucky' if state='KY')
4. Load active rules: `await loadActiveRules(jurisdiction)`
5. Evaluate eligibility: `await evaluateEligibility(answers, rules)`
6. Rank and deduplicate: `deduplicateMatches(rankMatches(rawMatches))`
7. Enrich with documentation: `enrichWithDocumentation(matches, documentationChecklists)`
8. Get current user (may be null for guest): `const { data: { user } } = await supabase.auth.getUser()`
9. Insert screening session:
   ```typescript
   const { data: session } = await supabase
     .from('screening_sessions')
     .insert({
       user_id: user?.id || null,
       answers,
       role: answers.role,
       status: 'completed'
     })
     .select('id')
     .single()
   ```
10. Insert screening results (one row per matched program):
    ```typescript
    await supabase.from('screening_results').insert(
      matches.map(m => ({
        session_id: session.id,
        program_id: m.programId,
        program_name: m.programName,
        confidence: m.confidence,
        confidence_label: m.confidenceLabel,
        required_docs: m.requiredDocs,
        next_steps: m.nextSteps,
        rule_version: 1
      }))
    )
    ```
11. Return { sessionId: session.id }
12. On error, return { error: 'Unable to process screening. Please try again.' }

**Update Review Page (`src/app/screening/intake/review/page.tsx`):**

Modify the review page to wire up the actual submission:
- Import submitScreening server action
- On "Submit" click:
  1. Set isSubmitting state to true
  2. Get all answers from useScreeningStore
  3. Call submitScreening(answers)
  4. If success, clear the Zustand store (reset()) and redirect to /screening/results/{sessionId}
  5. If error, show error message via toast (sonner) or inline alert
  6. Set isSubmitting state to false
- Disable Submit button while submitting, show "Processing your answers..." text
- Use useRouter for navigation after submission

**Results Page (`src/app/screening/results/[sessionId]/page.tsx`):**

Server Component that fetches and displays screening results.

1. Extract sessionId from params
2. Fetch screening session + results from Supabase:
   ```typescript
   const { data: session } = await supabase
     .from('screening_sessions')
     .select('*')
     .eq('id', sessionId)
     .single()

   const { data: results } = await supabase
     .from('screening_results')
     .select('*')
     .eq('session_id', sessionId)
     .order('confidence', { ascending: true })
   ```

3. If no session found, show "Results not found" with link back to /screening

4. Display results grouped by confidence level:

   **"Likely Eligible" section** (confidence = 'high'):
   - Green/success colored header
   - List of program cards

   **"Possibly Eligible" section** (confidence = 'medium'):
   - Yellow/warning colored header
   - List of program cards

   **"Worth Exploring" section** (confidence = 'low', if any):
   - Gray/muted header
   - List of program cards

5. Each program card shows:
   - Program name (heading)
   - Confidence badge ("Likely Eligible" or "Possibly Eligible")
   - Brief description
   - "Documents You'll Need" expandable section (use Accordion from shadcn/ui)
     - Each document: name, required/recommended badge, how to obtain
   - "Next Steps" list
   - Link to documentation checklist page (/resources/documents) for full details

6. Bottom section:
   - "Download Results (PDF)" button (client component, loaded next task)
   - "Start New Screening" link to /screening
   - Disclaimer: "These results are estimates based on the information you provided. Contact a Veterans Service Organization or benefits counselor to confirm your eligibility."

7. Cross-reference with documentation-checklists.ts to get full document details for each matched program

**RLS Policy Update (`supabase/migrations/00005_screening_rls_update.sql`):**

Update RLS policies to support guest screening (Pitfall 1 from research):

```sql
-- Drop overly restrictive SELECT policy
DROP POLICY IF EXISTS "Users can view own screening sessions" ON public.screening_sessions;

-- New SELECT policy: authenticated users see own, OR guest sessions readable
CREATE POLICY "Users can view screening sessions"
  ON public.screening_sessions FOR SELECT
  USING (
    auth.uid() = user_id
    OR user_id IS NULL
  );

-- RLS for screening_results
ALTER TABLE public.screening_results ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can read screening results"
  ON public.screening_results FOR SELECT
  USING (true);

CREATE POLICY "Service role inserts results"
  ON public.screening_results FOR INSERT
  WITH CHECK (true);
```

Note: The server action that inserts results runs server-side. If using the anon client, the INSERT policy needs to allow it. If that doesn't work, use the service role client for the insert operation (same pattern as ETL in Phase 2). Document which approach is used.
  </action>
  <verify>
Run `npm run build` to verify all pages and server action compile. Test the full flow: complete screening -> submit -> verify redirect to results page -> verify results display with program cards. Check that guest submission works (no auth required).
  </verify>
  <done>
Server action submits screening answers, evaluates eligibility, saves session and results to database, returns sessionId. Review page wires submit to server action with loading state. Results page displays matched programs grouped by confidence with documents and next steps. RLS policies updated for guest access. Full end-to-end screening flow works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PDF export and readability validation</name>
  <files>
    src/lib/pdf/screening-results.tsx
    src/app/screening/results/[sessionId]/pdf-download.tsx
    scripts/check-readability.ts
  </files>
  <action>
**Install @react-pdf/renderer:**

Run `npm install @react-pdf/renderer` before starting implementation.

Also install text-readability for readability validation:
Run `npm install text-readability`

**PDF Document Component (`src/lib/pdf/screening-results.tsx`):**

Create React PDF document component using @react-pdf/renderer (SCREEN-06).

```typescript
import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer'
```

PDF layout:
- Page 1 Header:
  - "Your Screening Results" title
  - Date generated
  - "Veteran Resource Management" branding

- For each confidence group ("Likely Eligible", "Possibly Eligible"):
  - Section header with confidence label
  - For each program:
    - Program name (bold)
    - Brief description
    - "Documents You'll Need:" heading
      - Bullet list of required documents with names
    - "Next Steps:" heading
      - Numbered list of action steps

- Footer on last page:
  - Disclaimer text
  - "Generated by Veteran Resource Management"
  - Date and session reference (no PII)

Props interface:
```typescript
interface ScreeningResultsPDFProps {
  generatedDate: string
  results: Array<{
    programName: string
    confidence: string
    confidenceLabel: string
    description?: string
    requiredDocs: string[]
    nextSteps: string[]
  }>
}
```

Use clean, professional styles. Font sizes: title 20pt, section headers 16pt, program names 13pt, body text 11pt, footer 9pt. Standard margins (30pt).

**PDF Download Button (`src/app/screening/results/[sessionId]/pdf-download.tsx`):**

Client component ('use client') that renders PDFDownloadLink from @react-pdf/renderer.

```typescript
'use client'

import dynamic from 'next/dynamic'

// Dynamic import to avoid SSR issues with @react-pdf/renderer
const PDFDownloadLink = dynamic(
  () => import('@react-pdf/renderer').then(mod => mod.PDFDownloadLink),
  { ssr: false, loading: () => <span>Preparing PDF...</span> }
)
```

Props: results array matching ScreeningResultsPDFProps.

Render a styled button that triggers PDF download:
- Text: "Download Results (PDF)" when ready
- Text: "Generating PDF..." while loading
- Download filename: `screening-results-{date}.pdf`
- Use Lucide Download icon next to text

Import this client component into the results page Server Component and pass results data as props.

**Readability Validation:**

Create `scripts/check-readability.ts` that validates screening content reads at 6th-8th grade level. Since text-readability is a CommonJS module, it may need special handling. If import fails, use createRequire from node:module.

Add npm script: `"check:readability": "npx tsx scripts/check-readability.ts"`
  </action>
  <verify>
Run `npm run build` to verify PDF components compile. Test PDF download on results page. Run `npm run check:readability` to verify content reading level.
  </verify>
  <done>
PDF document component renders screening results in professional layout. PDF download button on results page generates and downloads PDF client-side. Readability check script validates content meets 6th-8th grade level. `npm run check:readability` available as npm script.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete end-to-end screening flow</name>
  <files>none (verification only)</files>
  <action>
Human verification of the complete screening flow. No code changes -- this task verifies everything built in Tasks 1-2 and Plans 01-03 works end-to-end.

Pre-requisites the user must complete before testing:
1. Apply migration 00004 (eligibility tables) to Supabase SQL Editor
2. Apply migration 00005 (RLS updates) to Supabase SQL Editor
3. Run `npm run seed:rules` to populate eligibility rules
  </action>
  <verify>
User completes the 15-step verification checklist in how-to-verify below.
  </verify>
  <done>
User confirms: veteran flow works, caregiver flow works, conditional logic works, session persistence works, results display correctly, PDF downloads, no console errors.
  </done>
  <what-built>
Complete end-to-end screening flow: landing page -> 5-step questionnaire with conditional logic -> eligibility evaluation -> results page with ranked programs -> PDF download. Guest mode (no account required). Session persistence (resume after browser close).
  </what-built>
  <how-to-verify>
1. Run `npm run dev` to start the dev server
2. Navigate to http://localhost:3000/screening
3. Click "Start Screening"
4. Step 1: Select "I am a veteran" -- verify Next button enables
5. Step 2: Select Kentucky, age range, service era -- verify service era appears (veteran-specific)
6. Step 3: Select "Yes" for disability -- verify disability rating dropdown appears. Select income and employment.
7. Step 4: Check areas of need -- verify "Caregiver support" does NOT appear (you selected veteran, not caregiver)
8. Review: Verify all answers displayed correctly. Click "Submit"
9. Results page: Verify programs appear with "Likely Eligible" and "Possibly Eligible" groups
10. Click "Download Results (PDF)" -- verify PDF downloads with program list
11. TEST CAREGIVER: Start new screening, select "I am supporting a veteran"
    - Verify caregiver-specific questions appear on step 2
    - Verify "Caregiver support" appears in step 4 areas of need
    - Verify results include caregiver-relevant programs
12. TEST PERSISTENCE: Start screening, complete step 2, close browser tab, reopen -- verify step 2 answers preserved
13. Check browser console for any errors or hydration warnings
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Server action submits answers and returns sessionId
- [ ] Eligibility engine evaluates answers and returns ranked matches
- [ ] Screening session saved to database with answers and role
- [ ] Screening results saved to database with program matches
- [ ] Results page shows programs grouped by confidence level
- [ ] Each program shows required documents and next steps
- [ ] PDF download generates and downloads successfully
- [ ] Guest users can complete entire flow without account
- [ ] RLS policies allow guest session creation and reading
- [ ] Readability check passes (6th-8th grade level)
- [ ] No console errors or hydration warnings
- [ ] `npm run build` passes
</verification>

<success_criteria>
- End-to-end flow works: start screening -> answer questions -> see results -> download PDF
- Both veteran and caregiver roles produce appropriate results
- Guest mode works without authentication
- PDF contains matched programs with documents and next steps
- Content reads at 6th-8th grade level
- No data loss: answers persist in database, results persist in database
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-screening-eligibility-engine/03-04-SUMMARY.md`
</output>
