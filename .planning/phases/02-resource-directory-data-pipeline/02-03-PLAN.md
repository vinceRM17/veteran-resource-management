---
phase: 02-resource-directory-data-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/directory/page.tsx
  - src/app/directory/[id]/page.tsx
  - src/app/directory/layout.tsx
  - src/components/directory/search-form.tsx
  - src/components/directory/org-card.tsx
  - src/components/directory/verification-badge.tsx
  - src/components/directory/pagination-controls.tsx
  - src/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can search across 85K+ organizations using full-text search and see ranked results"
    - "User can filter organizations by state, service category, and VA accreditation"
    - "User can view organization detail page with contact info, services, and freshness status"
    - "Search state persists in URL params (bookmarkable, shareable)"
    - "Freshness badge shows green/yellow/red based on last_verified_date"
    - "Pagination works for large result sets (20 results per page)"
  artifacts:
    - path: "src/app/directory/page.tsx"
      provides: "Organization search page with filters and results"
    - path: "src/app/directory/[id]/page.tsx"
      provides: "Organization detail page with full information"
    - path: "src/components/directory/search-form.tsx"
      provides: "Search input + filter controls"
      exports: ["SearchForm"]
    - path: "src/components/directory/org-card.tsx"
      provides: "Organization result card component"
      exports: ["OrgCard"]
    - path: "src/components/directory/verification-badge.tsx"
      provides: "Data freshness indicator (green/yellow/red)"
      exports: ["VerificationBadge"]
    - path: "src/lib/db/queries.ts"
      provides: "Supabase RPC wrappers for search queries"
      exports: ["searchOrganizations", "getOrganizationById", "searchBusinesses"]
  key_links:
    - from: "src/app/directory/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "Server Component fetching search results"
      pattern: "searchOrganizations"
    - from: "src/lib/db/queries.ts"
      to: "supabase search_organizations RPC"
      via: "Supabase client RPC call"
      pattern: "supabase\\.rpc\\('search_organizations'"
    - from: "src/components/directory/verification-badge.tsx"
      to: "src/lib/db/types.ts"
      via: "getFreshnessStatus helper"
      pattern: "getFreshnessStatus"
    - from: "src/app/directory/[id]/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "Server Component fetching single org"
      pattern: "getOrganizationById"
---

<objective>
Build the organization search interface with full-text search, filters, pagination, detail pages, and data freshness indicators so veterans can discover and evaluate organizations that serve them.

Purpose: This is the primary user-facing feature of Phase 2. Veterans need to search, filter, and evaluate organizations. The search UI must handle 85K+ records with fast, ranked results.

Output: Organization search page with debounced search, state/category/accreditation filters, paginated results with freshness badges, and detail page with full organization information.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-resource-directory-data-pipeline/02-RESEARCH.md
@.planning/phases/02-resource-directory-data-pipeline/02-01-SUMMARY.md
@src/lib/db/types.ts
@supabase/migrations/00002_directory_schema.sql
@src/app/layout.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build organization search page with filters and paginated results</name>
  <files>
    src/app/directory/page.tsx
    src/app/directory/layout.tsx
    src/components/directory/search-form.tsx
    src/components/directory/org-card.tsx
    src/components/directory/verification-badge.tsx
    src/components/directory/pagination-controls.tsx
    src/lib/db/queries.ts
    package.json
  </files>
  <action>
**Install dependencies:**
```bash
npm install nuqs use-debounce
npx shadcn@latest add input select badge pagination card separator
```

**Query layer (`src/lib/db/queries.ts`):**

Create server-side query functions that wrap Supabase RPC calls:

```typescript
import { createClient } from '@/lib/supabase/server';

export async function searchOrganizations(params: {
  query?: string;
  state?: string;
  serviceCategory?: string;
  vaAccredited?: boolean;
  page?: number;
  pageSize?: number;
}) {
  const supabase = await createClient();
  const { data, error } = await supabase.rpc('search_organizations', {
    query_text: params.query || null,
    filter_state: params.state || null,
    filter_service_category: params.serviceCategory || null,
    filter_va_accredited: params.vaAccredited ?? null,
    filter_confidence_grade: null,
    page_number: params.page || 1,
    page_size: params.pageSize || 20,
  });
  if (error) throw error;
  return {
    results: data || [],
    totalCount: data?.[0]?.total_count ?? 0,
    page: params.page || 1,
    pageSize: params.pageSize || 20,
  };
}
```

Also create `getOrganizationById(id: string)` that queries the organizations table directly:
```typescript
const { data } = await supabase.from('organizations').select('*').eq('id', id).single();
```

And `searchBusinesses(params)` wrapping the search_businesses RPC (for Plan 04).

And `getDistinctStates()` that fetches `SELECT DISTINCT state FROM organizations WHERE state IS NOT NULL ORDER BY state` to populate the state filter dropdown.

And `getServiceCategories()` that fetches a predefined list of service categories (derived from the service_categories column -- common categories include: Housing, Healthcare, Mental Health, Employment, Education, Legal, Financial, Food, Transportation, Disability, Family Support, Substance Abuse, Homelessness, Benefits Assistance).

**Directory layout (`src/app/directory/layout.tsx`):**

Simple layout that wraps children with a container, page title "Resource Directory", and brief description. Use the NuqsAdapter provider from `nuqs/adapters/next/app` to wrap children for URL state management.

**Search form (`src/components/directory/search-form.tsx`):**

Client component ("use client") with:
- Search input with debounced onChange (300ms) using `use-debounce`
- URL state management using `useQueryState` from `nuqs` for: `q` (search query), `state` (state filter), `category` (service category), `va` (VA accredited filter), `page` (current page)
- State filter: Select dropdown populated with US states (from `getDistinctStates()` passed as prop, or hardcoded US states list)
- Service category filter: Select dropdown with common categories (Housing, Healthcare, Mental Health, Employment, Education, Legal, etc.)
- VA Accredited filter: checkbox or toggle
- "Clear filters" button that resets all params
- All filter changes reset page to 1
- Search input has `type="search"`, `aria-label="Search organizations"`, and a search icon (lucide Search icon)
- All form controls have visible labels for accessibility
- Responsive: filters stack vertically on mobile, horizontal on desktop (grid layout)

**Organization card (`src/components/directory/org-card.tsx`):**

Displays one search result:
- org_name as heading (link to `/directory/[id]`)
- city, state, zip on one line
- services_offered (truncated to 2 lines with line-clamp)
- VerificationBadge showing freshness status
- confidence_grade badge (color-coded: A/B = green, C = blue, D/F = yellow)
- Contact links: phone (tel:), email (mailto:), website (external link icon)
- VA Accredited badge if applicable
- Uses shadcn Card component for consistent styling
- Accessible: proper heading levels (h3), links have descriptive text

**Verification badge (`src/components/directory/verification-badge.tsx`):**

Small badge component that:
- Takes `lastVerifiedDate: string` prop
- Uses `getFreshnessStatus()` from types.ts to determine status
- Renders colored dot + text:
  - fresh (green): "Verified [date]"
  - stale (yellow): "Needs review - last verified [date]"
  - outdated (red): "Outdated - last verified [date]"
- Has tooltip (title attribute) with full date
- Uses appropriate ARIA: `aria-label="Data freshness: [status]"`

**Pagination controls (`src/components/directory/pagination-controls.tsx`):**

Client component that:
- Uses `useQueryState('page')` from nuqs
- Shows "Showing X-Y of Z results"
- Previous/Next buttons (disabled at boundaries)
- Page number display
- Uses shadcn Pagination component or custom accessible pagination
- Handles edge cases: 0 results shows "No results found", 1 page hides pagination

**Directory search page (`src/app/directory/page.tsx`):**

Server Component that:
- Reads searchParams from the page props (Next.js 16 async searchParams)
- Calls `searchOrganizations()` with params from URL
- Renders SearchForm (client component for interactivity)
- Renders list of OrgCard components with results
- Renders PaginationControls at bottom
- Shows "No organizations found" message when results are empty with suggestion to broaden search
- Shows result count: "Found X organizations"
- Handles loading state gracefully (React Suspense boundary around results)
  </action>
  <verify>
Run `npm run build` to verify all components compile. Start dev server (`npm run dev`), navigate to `/directory`. Type "mental health" in search -- should see results with mental health organizations ranked by relevance. Select a state filter -- results should narrow. Click an organization name -- should not navigate yet (detail page in next task). Verify URL updates with search params (`/directory?q=mental+health&state=KY`). Verify pagination works for large result sets.
  </verify>
  <done>
Organization search page renders with functional search input (debounced, FTS), state/category/accreditation filters stored in URL, paginated results showing organization cards with freshness badges, and "no results" handling. Search for "mental health" returns relevant organizations ranked by relevance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build organization detail page with full information and freshness display</name>
  <files>
    src/app/directory/[id]/page.tsx
  </files>
  <action>
**Organization detail page (`src/app/directory/[id]/page.tsx`):**

Server Component that:
1. Reads `id` from route params (Next.js 16 async params)
2. Calls `getOrganizationById(id)` from queries.ts
3. If not found, return `notFound()` from `next/navigation`
4. Renders full organization information in organized sections:

**Layout sections:**
- **Header:** org_name (h1), org_name_alt if present, org_type badge
- **Freshness banner:** VerificationBadge (large variant), confidence_grade badge, data_sources list
- **Contact info card:**
  - Street address (formatted with street_address, street_address_2, city, state, zip_code)
  - Phone with tel: link
  - Email with mailto: link
  - Website with external link (opens in new tab with rel="noopener noreferrer")
- **About section:**
  - Mission statement (full text)
  - Services offered (full text)
  - Service categories (rendered as badges/chips, semicolon-split)
  - Eligibility requirements
  - Service area
- **Classification section:**
  - NTEE code + description
  - IRS subsection
  - Tax-exempt status
  - VA accreditation status with details
  - Charity Navigator rating (stars display) and score
- **Financial summary** (only if data exists):
  - Total revenue, total expenses, total assets
  - Number of employees, volunteers
- **Back to search link:** "Back to directory" link that preserves the previous search URL (use `Link` from next/link)

**Accessibility requirements:**
- Proper heading hierarchy (h1 for name, h2 for sections, h3 for subsections)
- All external links have aria-label including organization name
- Contact links have descriptive labels ("Call [org name]", "Email [org name]")
- Skip links or anchor navigation for sections on long pages
- Use semantic elements: article, section, address

**Responsive design:**
- Full-width on mobile
- Two-column layout on desktop (contact card on right, content on left)
- Financial data in a grid layout

**Generate metadata:**
```typescript
export async function generateMetadata({ params }) {
  const { id } = await params;
  const org = await getOrganizationById(id);
  return {
    title: org ? `${org.org_name} | Veteran Resource Directory` : 'Organization Not Found',
    description: org?.mission_statement?.slice(0, 160) || 'Veteran organization details',
  };
}
```
  </action>
  <verify>
Run `npm run build` to verify the page compiles. Start dev server, search for an organization on `/directory`, click the organization name. Verify detail page loads with all sections populated. Check that the back link returns to the search results. Verify mobile layout stacks correctly. Test with a non-existent UUID -- should show 404.
  </verify>
  <done>
Organization detail page renders full organization information with contact, services, classification, financials, and freshness status. Page has proper metadata, accessible headings, and responsive layout. Non-existent IDs return 404.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Navigate to `/directory` -- search page loads with search input and filter controls
2. Search "mental health" -- results appear, ranked by relevance, with freshness badges
3. Filter by state "KY" -- results narrow to Kentucky organizations only
4. Click page 2 -- pagination works, URL updates
5. Click an organization -- detail page loads with full information
6. Browser back button returns to search with filters preserved
7. Directly visit `/directory?q=housing&state=OH` -- page loads with pre-filled search
8. `/directory/[nonexistent-uuid]` returns 404
9. `npm run build` succeeds
</verification>

<success_criteria>
- Full-text search returns relevant ranked results from 85K+ organizations
- State, service category, and VA accreditation filters work (AND logic)
- Pagination handles large result sets (20 per page)
- Organization detail page shows all information sections
- Freshness badges display green/yellow/red based on last_verified_date
- Search state persists in URL (bookmarkable)
- All components meet WCAG 2.1 AA accessibility standards
</success_criteria>

<output>
After completion, create `.planning/phases/02-resource-directory-data-pipeline/02-03-SUMMARY.md`
</output>
