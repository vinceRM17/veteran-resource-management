---
phase: 07-peer-connection-benefits-interaction-warnings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00008_peer_connection_search.sql
  - src/lib/db/peer-queries.ts
  - src/lib/db/peer-types.ts
  - src/app/peer-connection/page.tsx
  - src/app/peer-connection/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Supabase RPC function search_peer_connections exists and filters organizations by NTEE codes and location"
    - "Server query functions can fetch support groups, events, and opportunities with location and branch/era filters"
    - "Peer connection landing page at /peer-connection shows three category cards linking to sub-pages"
  artifacts:
    - path: "supabase/migrations/00008_peer_connection_search.sql"
      provides: "RPC function for NTEE-filtered location search with pagination"
      contains: "search_peer_connections"
    - path: "src/lib/db/peer-queries.ts"
      provides: "Server query functions for peer connection search"
      exports: ["searchPeerConnections"]
    - path: "src/lib/db/peer-types.ts"
      provides: "TypeScript types for peer connection search results and NTEE mappings"
      exports: ["PeerConnectionSearchResult", "PeerConnectionType", "NTEE_CODE_MAP"]
    - path: "src/app/peer-connection/page.tsx"
      provides: "Landing page with three category cards"
      min_lines: 40
    - path: "src/app/peer-connection/layout.tsx"
      provides: "Layout wrapper for peer connection section"
      min_lines: 10
  key_links:
    - from: "src/lib/db/peer-queries.ts"
      to: "supabase/migrations/00008_peer_connection_search.sql"
      via: "supabase.rpc('search_peer_connections')"
      pattern: "rpc\\('search_peer_connections'"
    - from: "src/app/peer-connection/page.tsx"
      to: "/peer-connection/support-groups"
      via: "Link href"
      pattern: "href=.*peer-connection/support-groups"
---

<objective>
Create the database layer and landing page for peer connection features. Veterans will be able to discover verified support groups, events, and opportunities from organizations already in the directory, filtered by NTEE codes and location.

Purpose: Establish the data access layer that all peer connection search pages will use, plus the entry point page.
Output: Migration SQL, server query functions, TypeScript types, and /peer-connection landing page.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 established the organizations table with NTEE codes, city, state, zip_code, va_accredited, ein, tax_exempt_status
@src/lib/db/types.ts
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + TypeScript types for peer connection search</name>
  <files>
    supabase/migrations/00008_peer_connection_search.sql
    src/lib/db/peer-types.ts
  </files>
  <action>
    Create migration `00008_peer_connection_search.sql` with a PostgreSQL RPC function `search_peer_connections` that:
    1. Accepts parameters: `filter_location TEXT`, `filter_ntee_codes TEXT[]`, `filter_branch TEXT`, `filter_era TEXT`, `page_number INT DEFAULT 1`, `page_size INT DEFAULT 20`
    2. Returns: id, org_name, city, state, zip_code, services_offered, ntee_code, ntee_description, ein, tax_exempt_status, va_accredited, phone, email, website, last_verified_date, confidence_score, rank (ROW_NUMBER), total_count
    3. Filter logic:
       - `filter_ntee_codes`: WHERE ntee_code LIKE ANY(filter_ntee_codes) — this supports wildcard patterns like 'W30%'
       - `filter_location`: WHERE (city ILIKE '%' || filter_location || '%' OR zip_code ILIKE filter_location || '%') — text-based location search matching existing pattern from search_organizations
       - `filter_branch` and `filter_era`: Currently pass-through (organizations table doesn't have branch/era columns yet). Add a comment noting this is placeholder for future enhancement. The filter parameters exist in the function signature for API stability.
       - All filters are optional (NULL = no filter)
    4. Pagination: OFFSET (page_number - 1) * page_size LIMIT page_size
    5. ORDER BY: va_accredited DESC (VA orgs first), confidence_score DESC NULLS LAST, org_name ASC
    6. Use LANGUAGE plpgsql STABLE (read-only function)
    7. Add COMMENT ON FUNCTION explaining purpose

    Create `src/lib/db/peer-types.ts` with:
    1. `PeerConnectionType` union type: `'support-groups' | 'events' | 'opportunities'`
    2. `NTEE_CODE_MAP` constant mapping each PeerConnectionType to NTEE code patterns:
       - 'support-groups': ['W30%', 'P20%', 'P40%'] (veterans orgs, support groups, family services)
       - 'events': ['W30%', 'A23%', 'A24%'] (veterans orgs, cultural programs, folk arts)
       - 'opportunities': ['W30%', 'J21%', 'J22%'] (veterans orgs, employment, vocational)
    3. `PeerConnectionSearchResult` interface matching the RPC function return columns (same shape as OrganizationSearchResult but with ntee_code, ntee_description, ein, tax_exempt_status added)
    4. `PeerConnectionSearchParams` interface: { type: PeerConnectionType; location?: string; branch?: string; era?: string; page?: number; pageSize?: number }
    5. `VerificationSource` type and `getVerificationSource(org)` function that determines verification badge info:
       - If va_accredited: { label: 'VA Accredited', source: 'U.S. Department of Veterans Affairs', tier: 'primary' }
       - If ein AND tax_exempt_status includes '501(c)(3)': { label: 'Verified Nonprofit', source: `Registered 501(c)(3) (EIN: ${ein})`, tier: 'secondary' }
       - If ein: { label: 'Registered Organization', source: 'IRS Exempt Organizations database', tier: 'tertiary' }
       - Default: { label: 'Listed Organization', source: 'Directory listing', tier: 'tertiary' }
    6. `PEER_CONNECTION_LABELS` constant mapping type to display name: { 'support-groups': 'Support Groups', 'events': 'Events & Activities', 'opportunities': 'Opportunities' }
    7. `PEER_CONNECTION_DESCRIPTIONS` constant with one-line descriptions for each type used on landing page cards
  </action>
  <verify>
    - `npx tsc --noEmit` passes (types compile)
    - Migration SQL file is valid SQL (no syntax errors visible)
    - NTEE_CODE_MAP has exactly 3 keys with correct code patterns
  </verify>
  <done>
    Migration file ready for manual application. TypeScript types and NTEE code mapping defined. getVerificationSource() classifies organizations into 4 verification tiers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Server query function + peer connection landing page</name>
  <files>
    src/lib/db/peer-queries.ts
    src/app/peer-connection/layout.tsx
    src/app/peer-connection/page.tsx
  </files>
  <action>
    Create `src/lib/db/peer-queries.ts` with "use server" directive:
    1. `searchPeerConnections(params: PeerConnectionSearchParams)` function:
       - Import createClient from '@/lib/supabase/server'
       - Look up NTEE codes from NTEE_CODE_MAP using params.type
       - Call supabase.rpc('search_peer_connections', { filter_location, filter_ntee_codes, filter_branch, filter_era, page_number, page_size })
       - Return `{ results: PeerConnectionSearchResult[], totalCount, page, pageSize, totalPages }` (same pattern as searchOrganizations in queries.ts)
       - Handle errors with console.error and throw

    Create `src/app/peer-connection/layout.tsx`:
    - Simple layout wrapper with max-w-6xl mx-auto px-4 py-8
    - Pass children through
    - Add metadata export: title "Peer Connections — Veteran Resource Management", description about finding verified support groups, events, and opportunities

    Create `src/app/peer-connection/page.tsx` as Server Component:
    - H1: "Connect with Fellow Veterans"
    - Subtitle: "Find verified support groups, events, and opportunities near you. Every listing is backed by a verified organization."
    - Three category cards using Next.js Link to /peer-connection/support-groups, /peer-connection/events, /peer-connection/opportunities
    - Each card shows: icon (Users for support groups, Calendar for events, Briefcase for opportunities from lucide-react), title from PEER_CONNECTION_LABELS, description from PEER_CONNECTION_DESCRIPTIONS, and a "Browse →" link
    - Cards in a responsive grid: grid-cols-1 md:grid-cols-3 gap-6
    - Use Card/CardHeader/CardContent/CardTitle/CardDescription from shadcn/ui (existing components)
    - Below cards, add a verification notice box: "All listings are verified through IRS nonprofit records, VA accreditation databases, or established veteran service organizations. We do not list unverified individuals or self-submitted profiles."
    - Use semantic HTML: main, section, article elements where appropriate
  </action>
  <verify>
    - `npm run build` passes (no build errors)
    - Landing page renders at /peer-connection with three category cards
    - Each card links to the correct sub-page URL
  </verify>
  <done>
    searchPeerConnections() server function calls RPC with NTEE code mapping. Landing page at /peer-connection shows three category cards with verification notice. Layout sets metadata.
  </done>
</task>

</tasks>

<verification>
- Migration 00008 contains valid SQL with search_peer_connections function
- TypeScript types compile without errors
- Server query function follows existing pattern from queries.ts
- Landing page accessible at /peer-connection
- Three cards link to support-groups, events, opportunities sub-pages
- Verification notice visible on landing page
</verification>

<success_criteria>
1. `npx tsc --noEmit` passes
2. `npm run build` passes
3. /peer-connection page renders with three category cards
4. searchPeerConnections() function is callable from server components
5. NTEE code mapping correctly classifies 3 peer connection types
</success_criteria>

<output>
After completion, create `.planning/phases/07-peer-connection-benefits-interaction-warnings/07-01-SUMMARY.md`
</output>
