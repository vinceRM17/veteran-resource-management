---
phase: 07-peer-connection-benefits-interaction-warnings
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/eligibility/interaction-types.ts
  - src/lib/eligibility/interaction-rules.ts
  - src/lib/eligibility/interaction-detector.ts
  - src/lib/eligibility/__tests__/interaction-detector.test.ts
  - src/components/screening/interaction-warning.tsx
  - src/app/screening/results/[sessionId]/page.tsx
  - src/app/screening/actions.ts
autonomous: true

must_haves:
  truths:
    - "When screening results contain SSI and SNAP, user sees warning about income interaction"
    - "When screening results contain SSI and Medicaid, user sees warning about eligibility cliff"
    - "When screening results contain VA disability compensation and SSI, user sees offset warning"
    - "Each warning includes plain-language explanation, recommendation, and link to benefits counselor"
    - "Interaction warnings appear between results sections and actions on the results page"
    - "Interaction detection runs only after eligibility evaluation completes (not during screening)"
  artifacts:
    - path: "src/lib/eligibility/interaction-types.ts"
      provides: "TypeScript types for benefit interactions and warnings"
      exports: ["BenefitInteraction", "InteractionSeverity", "InteractionRule"]
    - path: "src/lib/eligibility/interaction-rules.ts"
      provides: "3-5 benefit interaction rule definitions as typed data"
      exports: ["BENEFIT_INTERACTION_RULES"]
    - path: "src/lib/eligibility/interaction-detector.ts"
      provides: "Detection engine evaluating screening results for conflicts"
      exports: ["detectBenefitInteractions"]
    - path: "src/lib/eligibility/__tests__/interaction-detector.test.ts"
      provides: "Unit tests for interaction detection"
      min_lines: 80
    - path: "src/components/screening/interaction-warning.tsx"
      provides: "Warning banner component for screening results page"
      exports: ["InteractionWarningBanner", "InteractionWarningCard"]
    - path: "src/app/screening/results/[sessionId]/page.tsx"
      provides: "Updated results page with interaction warnings section"
      contains: "InteractionWarningBanner"
  key_links:
    - from: "src/lib/eligibility/interaction-detector.ts"
      to: "src/lib/eligibility/interaction-rules.ts"
      via: "imports BENEFIT_INTERACTION_RULES"
      pattern: "BENEFIT_INTERACTION_RULES"
    - from: "src/lib/eligibility/interaction-detector.ts"
      to: "json-rules-engine"
      via: "Engine for rule evaluation"
      pattern: "new Engine"
    - from: "src/app/screening/actions.ts"
      to: "src/lib/eligibility/interaction-detector.ts"
      via: "detectBenefitInteractions(matches, answers)"
      pattern: "detectBenefitInteractions"
    - from: "src/app/screening/results/[sessionId]/page.tsx"
      to: "src/components/screening/interaction-warning.tsx"
      via: "InteractionWarningBanner rendering"
      pattern: "InteractionWarningBanner"
---

<objective>
Implement benefits interaction detection that warns veterans when applying for one program might affect their eligibility for another. Uses json-rules-engine (already installed) to evaluate screening results for known conflicts.

Purpose: Veterans make informed decisions about which benefits to pursue first, avoiding surprise eligibility losses from benefit cliff effects.
Output: Interaction detection engine with 5 rules, unit tests, warning UI, and integration into screening results flow.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing eligibility engine pattern
@src/lib/eligibility/engine.ts
@src/lib/eligibility/confidence-scorer.ts
@src/lib/db/screening-types.ts

# Results page where warnings will appear
@src/app/screening/results/[sessionId]/page.tsx
@src/app/screening/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Interaction types, rules, and detection engine with TDD</name>
  <files>
    src/lib/eligibility/interaction-types.ts
    src/lib/eligibility/interaction-rules.ts
    src/lib/eligibility/interaction-detector.ts
    src/lib/eligibility/__tests__/interaction-detector.test.ts
  </files>
  <action>
    **RED phase — Write tests first:**

    Create `src/lib/eligibility/__tests__/interaction-detector.test.ts` with tests:
    1. "returns empty array when no program conflicts exist" — matches for unrelated programs (va-healthcare + snap-ky with low income) should return []
    2. "detects SSI + SNAP income interaction" — matches containing both 'ssi' and 'snap-ky' with income in '15k-25k' or '25k-40k' range should return warning
    3. "detects SSI + Medicaid eligibility cliff" — matches containing both 'ssi' and 'medicaid-ky' should return warning about Medicaid cliff
    4. "detects VA disability compensation + SSI offset" — matches containing both 'va-disability-compensation' and 'ssi' should return warning about VA offset
    5. "detects VA pension + SSI interaction" — matches containing both 'va-pension' and 'ssi' should return warning
    6. "detects SNAP + Medicaid cliff interaction" — matches containing both 'snap-ky' and 'medicaid-ky' with income in '25k-40k' range should return warning
    7. "returns multiple interactions when multiple conflicts exist" — matches containing ssi + snap-ky + medicaid-ky should return 2+ warnings
    8. "each interaction has required fields" — every returned BenefitInteraction has type, programIds, title, description, recommendation, and severity
    9. Use helper: createMockMatch(overrides) that creates a ProgramMatch with defaults (import ProgramMatch from screening-types)

    Import detectBenefitInteractions from interaction-detector.ts. Tests should use `describe`/`it` pattern. Run with `npx vitest run src/lib/eligibility/__tests__/interaction-detector.test.ts`.

    **GREEN phase — Implement types and engine:**

    Create `src/lib/eligibility/interaction-types.ts`:
    1. `InteractionSeverity` type: 'high' | 'medium' | 'low'
    2. `BenefitInteraction` interface: { type: 'warning' | 'conflict' | 'info'; programIds: string[]; title: string; description: string; recommendation: string; severity: InteractionSeverity; learnMoreUrl?: string }
    3. `InteractionRule` interface matching json-rules-engine rule shape: { name: string; conditions: { all?: ConditionProperties[]; any?: ConditionProperties[] }; event: { type: string; params: BenefitInteraction } }

    Create `src/lib/eligibility/interaction-rules.ts`:
    Define `BENEFIT_INTERACTION_RULES` array with 5 rules:

    1. **SSI + SNAP Income Interaction** (severity: medium)
       - Conditions: matchedProgramIds contains 'ssi' AND matchedProgramIds contains 'snap-ky' AND householdIncome in ['15k-25k', '25k-40k']
       - Title: "SSI May Affect Your SNAP Benefits"
       - Description: "SSI payments count as income for SNAP (food stamps) eligibility. If SSI pushes your total income above 130% of the federal poverty line, your SNAP benefits may decrease or end. SNAP typically decreases by about $1 for every $3 in additional income."
       - Recommendation: "Before applying for SSI, contact your local DCBS office at 1-855-459-6328 or speak with a benefits counselor to understand the total impact on your household."
       - learnMoreUrl: "https://www.ssa.gov/ssi/text-other-ussi.htm"

    2. **SSI + Medicaid Eligibility Cliff** (severity: high)
       - Conditions: matchedProgramIds contains 'ssi' AND matchedProgramIds contains 'medicaid-ky'
       - Title: "SSI and Medicaid Are Linked in Kentucky"
       - Description: "In Kentucky, SSI recipients automatically qualify for Medicaid. However, if your income increases and you lose SSI eligibility, you may also lose Medicaid coverage. This is known as a 'benefits cliff' — a small income increase can result in losing healthcare coverage."
       - Recommendation: "Talk to a benefits counselor about Section 1619(b) protections, which may let you keep Medicaid even if SSI payments stop due to earnings."
       - learnMoreUrl: "https://www.ssa.gov/disabilityresearch/wi/1619b.htm"

    3. **VA Disability Compensation + SSI Offset** (severity: medium)
       - Conditions: matchedProgramIds contains 'va-disability-compensation' AND matchedProgramIds contains 'ssi'
       - Title: "VA Disability Compensation Reduces SSI Payments"
       - Description: "VA disability compensation is counted as unearned income for SSI. Each dollar of VA compensation reduces your SSI payment dollar-for-dollar after the first $20/month exclusion. If your VA compensation is high enough, you may not qualify for SSI at all."
       - Recommendation: "Calculate your expected SSI amount after the VA offset. A Veterans Service Organization can help you understand the combined benefit amount."
       - learnMoreUrl: "https://www.ssa.gov/ssi/text-income-ussi.htm"

    4. **VA Pension + SSI Interaction** (severity: medium)
       - Conditions: matchedProgramIds contains 'va-pension' AND matchedProgramIds contains 'ssi'
       - Title: "You Generally Cannot Receive Both VA Pension and SSI"
       - Description: "VA pension payments count as income for SSI purposes. In most cases, VA pension and SSI combined cannot exceed the SSI federal benefit rate. Receiving one typically reduces or eliminates the other. You may need to choose which program provides the higher total benefit."
       - Recommendation: "Contact your local VA regional office or a Veterans Service Organization to calculate which program provides a higher benefit for your situation."
       - learnMoreUrl: "https://www.va.gov/pension/"

    5. **SNAP + Medicaid Income Cliff** (severity: low)
       - Conditions: matchedProgramIds contains 'snap-ky' AND matchedProgramIds contains 'medicaid-ky' AND householdIncome in ['25k-40k']
       - Title: "Monitor Income Thresholds for SNAP and Medicaid"
       - Description: "SNAP and Medicaid have different income limits. SNAP gross income limit is 130% of the federal poverty line, while Medicaid in Kentucky covers up to 138% FPL. A small income increase could push you over the SNAP limit first, then potentially the Medicaid limit."
       - Recommendation: "Keep track of your total household income. If your income changes, contact your local DCBS office to understand how it affects both programs."

    Create `src/lib/eligibility/interaction-detector.ts`:
    1. Import Engine from 'json-rules-engine', import ProgramMatch from screening-types, import BenefitInteraction from interaction-types, import BENEFIT_INTERACTION_RULES from interaction-rules
    2. `detectBenefitInteractions(matches: ProgramMatch[], answers: Record<string, unknown>): Promise<BenefitInteraction[]>`:
       - Create new Engine with allowUndefinedFacts: true (same as eligibility engine)
       - For each rule in BENEFIT_INTERACTION_RULES, add to engine using addRule():
         - Cast conditions to TopLevelCondition (same pattern as engine.ts)
         - Set event.type to 'benefit-interaction'
         - Set event.params to the rule's BenefitInteraction data
         - Set priority based on severity: high=10, medium=5, low=1
       - Build facts object:
         - matchedProgramIds: matches.map(m => m.programId)
         - Spread answers (for income, household size, etc.)
         - Add dynamic fact resolver for 'hasProgram' that checks if programId is in matchedProgramIds (NOT needed if using 'contains' operator on matchedProgramIds array)
       - Run engine, collect fired events
       - Map events to BenefitInteraction objects
       - Return interactions sorted by severity (high first)
    3. Handle the 'contains' operator: json-rules-engine v7 supports 'contains' operator on arrays natively. If matchedProgramIds is an array fact and the condition uses operator: 'contains', value: 'ssi', it checks if the array contains 'ssi'. Verify this works in tests.

    **Run tests:** `npx vitest run src/lib/eligibility/__tests__/interaction-detector.test.ts` — all 9 tests must pass.

    **REFACTOR if needed:** Clean up any redundant code, ensure consistent naming.
  </action>
  <verify>
    - `npx vitest run src/lib/eligibility/__tests__/interaction-detector.test.ts` — all tests pass
    - `npx tsc --noEmit` passes
    - 5 interaction rules defined with all required fields
  </verify>
  <done>
    detectBenefitInteractions() evaluates screening results for 5 known benefit interactions. All unit tests pass. Types enforce required fields on every interaction warning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Warning UI component and results page integration</name>
  <files>
    src/components/screening/interaction-warning.tsx
    src/app/screening/results/[sessionId]/page.tsx
    src/app/screening/actions.ts
  </files>
  <action>
    Create `src/components/screening/interaction-warning.tsx`:
    1. `InteractionWarningCard` component accepting { interaction: BenefitInteraction }:
       - Renders a Card with amber/yellow border for severity medium/low, red border for severity high
       - Icon: AlertTriangle from lucide-react (amber for medium/low, red for high)
       - Title in font-semibold
       - Description in text-sm text-muted-foreground
       - Recommendation in a highlighted box (bg-amber-50 or bg-red-50 depending on severity) with bold "Recommendation:" label
       - If learnMoreUrl exists, render "Learn more" link (external, opens in new tab)
       - Programs involved shown as small badges: programIds mapped to program names
    2. `InteractionWarningBanner` component accepting { interactions: BenefitInteraction[] }:
       - Returns null if interactions is empty
       - Wraps section with:
         - Header: "Important: Benefit Interactions Detected" with AlertTriangle icon
         - Subtext: "Some of the programs you may qualify for can affect each other. Review these warnings before applying."
         - Maps over interactions to render InteractionWarningCard for each
         - Footer note: "These warnings are for informational purposes. A benefits counselor can help you understand the full impact. Call 1-855-459-6328 (Kentucky DCBS) or contact a Veterans Service Organization."
       - Use rounded-lg border-2 border-amber-300 bg-amber-50/50 p-6 styling for the outer container
       - Accessible: role="alert" on the banner container, aria-label on the section

    Update `src/app/screening/actions.ts`:
    1. Import detectBenefitInteractions from interaction-detector.ts
    2. After the existing eligibility evaluation pipeline (evaluate → rank → deduplicate → enrich), add:
       ```
       const interactions = await detectBenefitInteractions(matches, answers);
       ```
    3. Store interactions in the screening_sessions table by updating the existing session row. Add interactions to the session's answers JSONB field under a separate key, OR better: store as a new column. Since we want to avoid a migration for this, store as part of the response object:
       - Add `interactions` to the submitScreening return type: `interactions?: BenefitInteraction[]`
       - Return interactions alongside sessionId
    4. ALSO, we need to persist interactions so the results page can display them. Since the results page is a Server Component that fetches from the database, we need to store interactions somewhere accessible.
       - Best approach: Add interactions to the screening_results query by storing them in a `benefit_interactions` JSONB column on screening_sessions. But this requires a migration.
       - Simpler approach for MVP: The results page re-computes interactions from the stored results. This is acceptable because:
         a) The results page already loads all screening_results for the session
         b) The results page already loads the session's answers
         c) detectBenefitInteractions is fast (in-memory rules engine, no DB queries)
       - **Use the re-computation approach:** In the results page, after loading results and session, call detectBenefitInteractions(programMatches, session.answers) and pass to InteractionWarningBanner.

    Update `src/app/screening/results/[sessionId]/page.tsx`:
    1. Import detectBenefitInteractions from interaction-detector.ts
    2. Import InteractionWarningBanner from interaction-warning.tsx
    3. After fetching screening results and building the grouped results, compute interactions:
       ```typescript
       // Convert ScreeningResult[] to ProgramMatch[] for interaction detection
       const programMatches: ProgramMatch[] = screeningResults.map(r => ({
         programId: r.program_id,
         programName: r.program_name,
         confidence: r.confidence,
         confidenceLabel: r.confidence_label,
         requiredDocs: r.required_docs,
         nextSteps: r.next_steps,
         description: getProgramDescription(r.program_id) || '',
       }));
       const interactions = await detectBenefitInteractions(programMatches, answers);
       ```
    4. Render InteractionWarningBanner AFTER the results sections (after the "Worth Exploring" section) and BEFORE the "Organizations Near You" section. Place it between a Separator:
       ```tsx
       {interactions.length > 0 && (
         <>
           <Separator className="my-8" />
           <InteractionWarningBanner interactions={interactions} />
         </>
       )}
       ```
    5. This placement ensures the veteran sees their eligible programs first, then the interaction warnings that help them make informed decisions about which to pursue.
  </action>
  <verify>
    - `npm run build` passes
    - Results page with SSI + SNAP matches shows interaction warning
    - Warning includes title, description, recommendation, and learn more link
    - InteractionWarningBanner returns null when no interactions
    - Warning section has proper accessibility attributes (role="alert")
  </verify>
  <done>
    InteractionWarningBanner renders benefit interaction warnings on the screening results page. Warnings appear after program results and before local organizations section. Each warning shows title, plain-language explanation, recommendation, and counselor contact information.
  </done>
</task>

</tasks>

<verification>
- All interaction detection tests pass
- Results page shows warnings when conflicting programs are matched
- Each warning has title, description, recommendation, and optional learn more link
- Warnings correctly identify 5 known benefit interactions
- No warnings shown when no conflicts exist
- Interaction detection runs after eligibility evaluation (not during screening)
- Build passes with no errors
</verification>

<success_criteria>
1. `npx vitest run src/lib/eligibility/__tests__/interaction-detector.test.ts` — all tests pass
2. `npm run build` passes with no errors
3. Screening results page with SSI + SNAP programs shows "SSI May Affect Your SNAP Benefits" warning
4. Warning includes plain-language explanation and "Contact DCBS" recommendation
5. Warning includes "Learn more" link to SSA documentation
6. No warnings shown when only non-conflicting programs are matched
7. Multiple warnings shown when multiple conflicts detected
</success_criteria>

<output>
After completion, create `.planning/phases/07-peer-connection-benefits-interaction-warnings/07-03-SUMMARY.md`
</output>
