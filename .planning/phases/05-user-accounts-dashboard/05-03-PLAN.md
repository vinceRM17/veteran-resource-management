---
phase: 05-user-accounts-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/directory/BookmarkButton.tsx
  - src/app/directory/[id]/page.tsx
  - src/app/directory/businesses/[id]/page.tsx
  - src/app/dashboard/bookmarks/page.tsx
  - src/app/dashboard/action-items/page.tsx
  - src/lib/db/bookmark-actions.ts
  - src/lib/db/action-item-actions.ts
autonomous: true

must_haves:
  truths:
    - "User can bookmark an organization from its detail page"
    - "User can bookmark a business from its detail page"
    - "User can view all bookmarks on a dedicated bookmarks page"
    - "User can remove a bookmark"
    - "User can check off action items and see progress bar"
    - "User can view all action items on a dedicated page"
  artifacts:
    - path: "src/components/directory/BookmarkButton.tsx"
      provides: "Reusable bookmark toggle button"
      contains: "BookmarkButton"
    - path: "src/lib/db/bookmark-actions.ts"
      provides: "Server actions for bookmark CRUD"
      exports: ["toggleBookmark", "getUserBookmarks", "isBookmarked"]
    - path: "src/lib/db/action-item-actions.ts"
      provides: "Server actions for action item CRUD"
      exports: ["toggleActionItem", "getActionItems", "deleteActionItem"]
    - path: "src/app/dashboard/bookmarks/page.tsx"
      provides: "Bookmarks list page"
      min_lines: 60
    - path: "src/app/dashboard/action-items/page.tsx"
      provides: "Action items page with progress bar"
      min_lines: 80
  key_links:
    - from: "src/components/directory/BookmarkButton.tsx"
      to: "src/lib/db/bookmark-actions.ts"
      via: "toggleBookmark server action"
      pattern: "toggleBookmark"
    - from: "src/app/dashboard/bookmarks/page.tsx"
      to: "src/lib/db/bookmark-actions.ts"
      via: "getUserBookmarks query"
      pattern: "getUserBookmarks"
    - from: "src/app/dashboard/action-items/page.tsx"
      to: "src/lib/db/action-item-actions.ts"
      via: "toggleActionItem and getActionItems"
      pattern: "toggleActionItem|getActionItems"
---

<objective>
Build the bookmarking system and action item tracking. Users can bookmark organizations/businesses from detail pages, view bookmarks in a list, and track action steps from screening results with a checkbox + progress bar interface.

Purpose: These are the core engagement features that keep veterans coming back — saving resources and tracking progress.
Output: BookmarkButton component, bookmark server actions, bookmarks page, action items page with progress tracking.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-accounts-dashboard/05-01-SUMMARY.md

Key existing files:
@src/lib/db/dashboard-types.ts — Bookmark, ActionItem types (from Plan 01)
@supabase/migrations/00007_user_accounts_dashboard.sql — bookmarks and action_items table schemas
@src/app/directory/[id]/page.tsx — organization detail page (add bookmark button here)
@src/app/directory/businesses/[id]/page.tsx — business detail page (add bookmark button here)
@src/app/dashboard/layout.tsx — dashboard layout with auth guard (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bookmark server actions and BookmarkButton component</name>
  <files>src/lib/db/bookmark-actions.ts, src/components/directory/BookmarkButton.tsx, src/app/directory/[id]/page.tsx, src/app/directory/businesses/[id]/page.tsx</files>
  <action>
**1. Create `src/lib/db/bookmark-actions.ts`** with server actions:

```typescript
"use server";

import { createClient } from '@/lib/supabase/server';
import type { Bookmark } from '@/lib/db/dashboard-types';

export async function toggleBookmark(
  resourceType: 'organization' | 'business' | 'program',
  resourceId: string,
  resourceName: string,
): Promise<{ bookmarked: boolean; error?: string }> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { bookmarked: false, error: "You must be logged in to bookmark resources." };
  }

  // Check if bookmark already exists
  const { data: existing } = await supabase
    .from('bookmarks')
    .select('id')
    .eq('user_id', user.id)
    .eq('resource_type', resourceType)
    .eq('resource_id', resourceId)
    .maybeSingle();

  if (existing) {
    // Remove bookmark
    await supabase.from('bookmarks').delete().eq('id', existing.id);
    return { bookmarked: false };
  }

  // Add bookmark
  const { error } = await supabase.from('bookmarks').insert({
    user_id: user.id,
    resource_type: resourceType,
    resource_id: resourceId,
    resource_name: resourceName,
  });

  if (error) {
    console.error('Failed to create bookmark:', error);
    return { bookmarked: false, error: "Unable to save bookmark." };
  }

  return { bookmarked: true };
}

export async function isBookmarked(
  resourceType: string,
  resourceId: string,
): Promise<boolean> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return false;

  const { data } = await supabase
    .from('bookmarks')
    .select('id')
    .eq('user_id', user.id)
    .eq('resource_type', resourceType)
    .eq('resource_id', resourceId)
    .maybeSingle();

  return !!data;
}

export async function getUserBookmarks(): Promise<Bookmark[]> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return [];

  const { data } = await supabase
    .from('bookmarks')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  return (data || []) as Bookmark[];
}

export async function removeBookmark(bookmarkId: string): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return { success: false, error: "Not authenticated." };

  const { error } = await supabase
    .from('bookmarks')
    .delete()
    .eq('id', bookmarkId)
    .eq('user_id', user.id); // RLS double-check

  if (error) return { success: false, error: "Unable to remove bookmark." };
  return { success: true };
}
```

**2. Create `src/components/directory/BookmarkButton.tsx`:**
Client component for toggling bookmarks on directory detail pages.

Props: `{ resourceType: 'organization' | 'business' | 'program'; resourceId: string; resourceName: string; initialBookmarked: boolean; isLoggedIn: boolean }`

Behavior:
- If not logged in: button shows "Save" with Bookmark icon, on click shows toast (via sonner) "Log in to save resources" with link to /login
- If logged in: toggle between filled/outlined bookmark icon. On click, call toggleBookmark server action. Show loading state. Use optimistic UI — immediately toggle visual state, revert on error.
- Use shadcn Button with variant="outline", size="sm"
- Icons: Bookmark and BookmarkCheck from lucide-react (or use Bookmark with fill for bookmarked state)
- Include aria-label: "Save {resourceName}" or "Remove {resourceName} from saved"

**3. Add BookmarkButton to organization detail page `src/app/directory/[id]/page.tsx`:**
- Import BookmarkButton and isBookmarked
- At top of the component, after fetching org, check auth and bookmark status:
  ```typescript
  const { data: { user } } = await supabase.auth.getUser();
  const bookmarked = user ? await isBookmarked('organization', id) : false;
  ```
  Note: need to import createClient from supabase/server. It's already imported via getOrganizationById but we need direct access. Add `import { createClient } from '@/lib/supabase/server';`
- Place BookmarkButton in the header section next to the org name or in the sidebar contact card:
  ```tsx
  <BookmarkButton
    resourceType="organization"
    resourceId={id}
    resourceName={org.org_name}
    initialBookmarked={bookmarked}
    isLoggedIn={!!user}
  />
  ```
  Position: Add it right after the org_name_alt paragraph in the header div, before the org_type badge. Or better — add it as a floating button in the sidebar Card, below the contact info.

**4. Add BookmarkButton to business detail page `src/app/directory/businesses/[id]/page.tsx`:**
Same pattern as organizations. Read the file first, then add:
- Import BookmarkButton and isBookmarked
- Fetch user auth status and bookmark check
- Place BookmarkButton in appropriate location (header area or sidebar)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. BookmarkButton component renders different states for logged-in vs guest
3. toggleBookmark action creates and removes bookmarks
4. Organization detail page includes BookmarkButton with correct props
5. Business detail page includes BookmarkButton with correct props
  </verify>
  <done>
Bookmark toggle works on both organization and business detail pages. Guests see login prompt, authenticated users can toggle bookmarks with optimistic UI. Server actions handle CRUD with proper auth checks and RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bookmarks list page and action items page with progress tracking</name>
  <files>src/app/dashboard/bookmarks/page.tsx, src/app/dashboard/action-items/page.tsx, src/lib/db/action-item-actions.ts</files>
  <action>
**1. Create `src/lib/db/action-item-actions.ts`** with server actions:

```typescript
"use server";

import { createClient } from '@/lib/supabase/server';
import type { ActionItem } from '@/lib/db/dashboard-types';

export async function getActionItems(): Promise<ActionItem[]> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return [];

  const { data } = await supabase
    .from('action_items')
    .select('*')
    .eq('user_id', user.id)
    .order('is_completed', { ascending: true })
    .order('sort_order', { ascending: true });

  return (data || []) as ActionItem[];
}

export async function toggleActionItem(
  itemId: string,
): Promise<{ success: boolean; isCompleted: boolean; error?: string }> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return { success: false, isCompleted: false, error: "Not authenticated." };

  // Fetch current state
  const { data: item } = await supabase
    .from('action_items')
    .select('is_completed')
    .eq('id', itemId)
    .eq('user_id', user.id)
    .single();

  if (!item) return { success: false, isCompleted: false, error: "Action item not found." };

  const newState = !item.is_completed;

  const { error } = await supabase
    .from('action_items')
    .update({
      is_completed: newState,
      completed_at: newState ? new Date().toISOString() : null,
    })
    .eq('id', itemId)
    .eq('user_id', user.id);

  if (error) return { success: false, isCompleted: item.is_completed, error: "Unable to update." };

  return { success: true, isCompleted: newState };
}

export async function deleteActionItem(
  itemId: string,
): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return { success: false, error: "Not authenticated." };

  const { error } = await supabase
    .from('action_items')
    .delete()
    .eq('id', itemId)
    .eq('user_id', user.id);

  if (error) return { success: false, error: "Unable to delete." };
  return { success: true };
}
```

**2. Create `src/app/dashboard/bookmarks/page.tsx`:**
Server Component that displays the user's bookmarked resources.

- Import getUserBookmarks from bookmark-actions and removeBookmark
- Page title: "Saved Resources"
- Breadcrumb: Dashboard > Saved Resources
- Group bookmarks by resource_type: Organizations, Businesses, Programs
- Each bookmark displayed as a Card with:
  - resource_name as title
  - resource_type as Badge (color-coded: blue for org, green for business, purple for program)
  - "View" link: for organizations → /directory/{resource_id}, for businesses → /directory/businesses/{resource_id}, for programs → link to last screening results or generic
  - "Remove" button (small, outline variant) — client component wrapper needed for the remove action
  - created_at formatted as "Saved on {date}"
- Empty state: "No saved resources yet. Browse the directory to find organizations and businesses."
- Link back to /directory

Create a small client component `RemoveBookmarkButton` inline or in a separate file that calls removeBookmark and uses `useRouter().refresh()` to update the page.

**3. Create `src/app/dashboard/action-items/page.tsx`:**
Client component (needs interactivity for checkboxes) that displays action items with progress tracking.

- Fetch initial data server-side, pass to client component, OR make it a client component that fetches on mount
- Better approach: Server Component wrapper that fetches data, passes to a client ActionItemsList component

Structure:
- Page title: "Action Items"
- Breadcrumb: Dashboard > Action Items
- Progress bar at top: green filled bar showing completion percentage, "X of Y steps completed" text
- Group items by program_name (if available)
- Each item rendered with:
  - shadcn Checkbox (from @radix-ui/react-checkbox, already in project)
  - Title text (the next_step text)
  - Program name as small gray text underneath
  - Strikethrough and muted text when completed
  - Delete button (X icon, small) to remove item
- Optimistic UI: checkbox toggles immediately, reverts on error
- When all items for a program are complete, show a small celebration message ("All steps complete for {program_name}!")
- Empty state: "No action items yet. Complete a screening and save your results to get personalized next steps."
- Link to /screening

The progress bar implementation:
```tsx
<div className="w-full bg-gray-200 rounded-full h-3">
  <div
    className="bg-green-500 h-3 rounded-full transition-all duration-300"
    style={{ width: `${(completed / total) * 100}%` }}
  />
</div>
<p className="text-sm text-muted-foreground mt-1">{completed} of {total} steps completed</p>
```

Note on auth: Both pages live under /dashboard which has the auth guard layout from Plan 02, so no additional auth check needed at the page level.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Bookmarks page lists bookmarks grouped by type with view/remove actions
3. Action items page shows items with checkboxes and progress bar
4. Toggling checkbox calls toggleActionItem and updates UI
5. Removing bookmark calls removeBookmark and refreshes page
6. Empty states display correctly when no data
  </verify>
  <done>
Bookmarks page shows saved organizations, businesses, and programs with remove capability. Action items page shows per-program grouped checklist with progress bar. Checkbox toggles use optimistic UI. Both pages are auth-protected via dashboard layout.
  </done>
</task>

</tasks>

<verification>
1. BookmarkButton appears on organization detail page
2. BookmarkButton appears on business detail page
3. Clicking bookmark as guest shows login prompt
4. Clicking bookmark as user toggles bookmark state
5. /dashboard/bookmarks lists all saved bookmarks grouped by type
6. /dashboard/action-items shows action items with progress bar
7. Checking off action items updates progress percentage
8. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- User can bookmark organizations from /directory/[id] detail pages
- User can bookmark businesses from /directory/businesses/[id] detail pages
- User can view all bookmarks at /dashboard/bookmarks with remove capability
- User can check off action items at /dashboard/action-items
- Progress bar accurately reflects completion percentage
- All features require authentication (dashboard layout guard)
- Guest users see login prompt when trying to bookmark
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-accounts-dashboard/05-03-SUMMARY.md`
</output>
