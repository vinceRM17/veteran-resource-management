---
phase: 05-user-accounts-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/app/dashboard/page.tsx
  - src/app/admin/layout.tsx
  - src/lib/supabase/middleware.ts
  - src/middleware.ts
autonomous: false

must_haves:
  truths:
    - "Dashboard shows bookmarks count with link to bookmarks page"
    - "Dashboard shows action item progress with link to action items page"
    - "Admin routes are protected and only accessible to admin-role users"
    - "Non-admin user visiting /admin sees redirect or access denied"
    - "All Phase 5 features work end-to-end"
  artifacts:
    - path: "src/app/dashboard/page.tsx"
      provides: "Complete dashboard with all sections wired"
      contains: "bookmarks"
    - path: "src/app/admin/layout.tsx"
      provides: "Admin layout with role-based access control"
      contains: "admin"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/db/dashboard-queries.ts"
      via: "getUserBookmarkCount and getActionItemProgress"
      pattern: "getUserBookmarkCount|getActionItemProgress"
    - from: "src/app/admin/layout.tsx"
      to: "public.profiles"
      via: "role check query"
      pattern: "role.*admin"
---

<objective>
Wire the complete dashboard together with live bookmark/action-item data, protect admin routes with role-based access control, and verify all Phase 5 features end-to-end.

Purpose: Final integration ensures all pieces connect and admin security is properly enforced.
Output: Fully wired dashboard, admin route protection, verification checkpoint.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-accounts-dashboard/05-01-SUMMARY.md
@.planning/phases/05-user-accounts-dashboard/05-02-SUMMARY.md
@.planning/phases/05-user-accounts-dashboard/05-03-SUMMARY.md

Key existing files:
@src/app/dashboard/page.tsx — dashboard with screening history (from Plan 02)
@src/lib/db/dashboard-queries.ts — query functions (from Plan 02)
@src/app/admin/layout.tsx — current admin layout (no auth protection)
@src/lib/supabase/middleware.ts — Supabase session refresh middleware
@src/middleware.ts — Next.js middleware
@src/app/admin/crisis-monitoring/page.tsx — crisis monitoring page
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire dashboard with live data and protect admin routes</name>
  <files>src/app/dashboard/page.tsx, src/app/admin/layout.tsx</files>
  <action>
**1. Verify and update `src/app/dashboard/page.tsx`:**
The dashboard was created in Plan 02 with quick stats sections. Verify that:
- getUserBookmarkCount is called and displays the count
- getActionItemProgress is called and displays the progress bar
- Bookmarks section links to /dashboard/bookmarks
- Action items section links to /dashboard/action-items
- Each section has proper empty states and loading fallbacks

If any of these are stub/placeholder values from Plan 02, wire them to the actual query functions from dashboard-queries.ts. The dashboard should show:

Quick stats row (3 cards side by side on desktop, stacked on mobile):
1. **Screenings**: Total count, link to history below
2. **Saved Resources**: Bookmark count from getUserBookmarkCount, link to /dashboard/bookmarks
3. **Action Steps**: "X of Y complete" from getActionItemProgress, small progress bar, link to /dashboard/action-items

Add navigation links between dashboard sub-pages:
```tsx
<nav className="flex gap-4 mb-6" aria-label="Dashboard navigation">
  <Link href="/dashboard" className="font-medium text-sm underline">Overview</Link>
  <Link href="/dashboard/bookmarks" className="text-sm text-muted-foreground hover:underline">Saved Resources</Link>
  <Link href="/dashboard/action-items" className="text-sm text-muted-foreground hover:underline">Action Items</Link>
</nav>
```

**2. Protect admin routes in `src/app/admin/layout.tsx`:**
Replace the current unprotected admin layout with one that checks the user's profile role:

```typescript
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import type { ReactNode } from 'react';

export default async function AdminLayout({ children }: { children: ReactNode }) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  // Check admin role from profiles table
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();

  if (!profile || profile.role !== 'admin') {
    redirect('/dashboard');
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-red-700 text-white shadow">
        <div className="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8">
          <h1 className="text-2xl font-bold">Admin Dashboard</h1>
          <p className="mt-1 text-sm text-red-100">
            Internal monitoring and management tools
          </p>
        </div>
      </header>
      <main className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}
```

This removes the comment about deferring auth protection and implements actual role-based access control. Non-admin users are redirected to /dashboard. Unauthenticated users are redirected to /login.

The RLS policies from migration 00007 (crisis logs admin-only) provide database-level protection. This layout check provides UI-level protection. Both layers ensure only admins access admin features.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Dashboard page calls getUserBookmarkCount and getActionItemProgress
3. Dashboard shows navigation links to sub-pages
4. Admin layout checks profile role and redirects non-admins
5. Admin layout redirects unauthenticated users to /login
  </verify>
  <done>
Dashboard fully wired with live bookmark count and action item progress. Admin routes protected with role-based access control at both UI level (layout redirect) and database level (RLS policies). Non-admin users see redirect to /dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Phase 5 end-to-end</name>
  <files>src/app/dashboard/page.tsx, src/app/admin/layout.tsx</files>
  <action>
Human verification checkpoint. What was built:
1. Database tables: bookmarks, action_items with RLS
2. Crisis log RLS tightened to admin-only
3. Guest session claiming after account creation
4. Dashboard with screening history, bookmark count, action item progress
5. Bookmark buttons on org/business detail pages
6. Bookmarks list page with remove capability
7. Action items page with checkbox tracking and progress bar
8. Save Results CTA on screening results page
9. Admin route protection with role-based access

**Prerequisites:** Apply migration 00007 via Supabase Dashboard SQL Editor.

**1. Guest Screening to Account Creation Flow:**
  a. Open browser in incognito/private mode
  b. Go to /screening, complete screening as guest
  c. On results page, verify "Save Your Results" CTA appears
  d. Click "Sign Up to Save"
  e. Verify redirected to signup page
  f. Create account, confirm email
  g. Verify redirect to dashboard (via auth callback)
  h. Verify screening appears in dashboard history

**2. Dashboard:**
  a. Log in with test account
  b. Navigate to /dashboard
  c. Verify screening history shows dates, roles, and matched programs
  d. Verify quick stats show correct counts
  e. Verify navigation links to bookmarks and action items pages

**3. Bookmarks:**
  a. Navigate to /directory, click into an organization
  b. Verify bookmark button visible
  c. Click bookmark — should toggle to saved state
  d. Navigate to /dashboard/bookmarks — verify org appears
  e. Remove bookmark — verify it disappears
  f. Repeat for a business at /directory/businesses/[id]

**4. Action Items:**
  a. Navigate to /dashboard/action-items
  b. Verify action items created from screening next_steps
  c. Check off an item — verify checkbox fills and progress bar updates
  d. Verify progress percentage is accurate
  e. Uncheck an item — verify it reverts

**5. Admin Protection:**
  a. Log in with a non-admin account
  b. Navigate to /admin/crisis-monitoring
  c. Verify redirect to /dashboard (not crisis monitoring page)
  d. (Optional) Set a test user's profile role to 'admin' in Supabase SQL Editor, verify admin page loads

**6. Header Navigation:**
  a. When logged in: verify Dashboard link appears in header
  b. When logged out: verify Dashboard link does NOT appear

Resume signal: Type "approved" or describe issues found.
  </action>
  <verify>User performs manual verification of all 6 test scenarios above and reports "approved" or describes issues.</verify>
  <done>All Phase 5 success criteria verified by human testing: dashboard, bookmarks, action items, session claiming, admin protection, and header navigation all work end-to-end.</done>
</task>

</tasks>

<verification>
1. Dashboard wired with live bookmark and action item data
2. Admin routes protected with role check
3. All Phase 5 success criteria met (see ROADMAP.md Phase 5 criteria)
4. No TypeScript errors
5. Human verification confirms end-to-end functionality
</verification>

<success_criteria>
- Dashboard shows accurate, live data for all sections
- Admin routes inaccessible to non-admin users
- Full guest→signup→dashboard flow works end-to-end
- Bookmark and action item features work as expected
- Phase 5 success criteria from ROADMAP all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-accounts-dashboard/05-04-SUMMARY.md`
</output>
