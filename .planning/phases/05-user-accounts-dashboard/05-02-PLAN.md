---
phase: 05-user-accounts-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/dashboard/page.tsx
  - src/app/dashboard/layout.tsx
  - src/lib/db/dashboard-queries.ts
  - src/app/screening/results/[sessionId]/page.tsx
  - src/components/screening/SaveResultsCTA.tsx
  - src/components/layout/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Logged-in user sees personalized dashboard with screening history"
    - "Dashboard shows past screenings with dates and matched program names"
    - "User sees a Save to Account prompt on screening results page"
    - "Header navigation shows Dashboard link when user is logged in"
  artifacts:
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard page with screening history and quick stats"
      min_lines: 80
    - path: "src/lib/db/dashboard-queries.ts"
      provides: "Server-side queries for dashboard data"
      exports: ["getScreeningHistory", "getUserBookmarks", "getActionItemProgress"]
    - path: "src/components/screening/SaveResultsCTA.tsx"
      provides: "Save results call-to-action for guest users"
      contains: "SaveResultsCTA"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/db/dashboard-queries.ts"
      via: "getScreeningHistory import"
      pattern: "getScreeningHistory"
    - from: "src/app/dashboard/page.tsx"
      to: "supabase screening_sessions + screening_results"
      via: "server component data fetch"
      pattern: "screening_sessions"
    - from: "src/components/screening/SaveResultsCTA.tsx"
      to: "src/app/screening/actions.ts"
      via: "claimGuestSession server action"
      pattern: "claimGuestSession"
---

<objective>
Build the personalized dashboard page with screening history display and the post-screening "Save to Account" CTA component. Users who completed a screening as guests see a prompt to create an account and save their results.

Purpose: This is the primary value of Phase 5 — veterans see their screening history and can save results for later.
Output: Dashboard page, dashboard query functions, save-results CTA component, updated Header nav.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-accounts-dashboard/05-01-SUMMARY.md

Key existing files:
@src/lib/db/screening-types.ts — ScreeningSession, ScreeningResult, ProgramMatch types
@src/lib/db/dashboard-types.ts — Bookmark, ActionItem, ScreeningHistoryEntry types (from Plan 01)
@src/app/screening/actions.ts — claimGuestSession, createActionItemsFromResults (from Plan 01)
@src/app/screening/results/[sessionId]/page.tsx — current results page (needs SaveResultsCTA)
@src/components/layout/Header.tsx — existing Header with user auth check
@src/app/(auth)/signup/page.tsx — signup page with redirectTo support (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard queries and page</name>
  <files>src/lib/db/dashboard-queries.ts, src/app/dashboard/page.tsx, src/app/dashboard/layout.tsx</files>
  <action>
**1. Create `src/lib/db/dashboard-queries.ts`** with server-side query functions:

```typescript
import { createClient } from '@/lib/supabase/server';
import type { ScreeningHistoryEntry } from '@/lib/db/dashboard-types';

export async function getScreeningHistory(userId: string): Promise<ScreeningHistoryEntry[]> {
  const supabase = await createClient();

  // Fetch completed sessions for this user
  const { data: sessions } = await supabase
    .from('screening_sessions')
    .select('id, answers, role, status, created_at')
    .eq('user_id', userId)
    .eq('status', 'completed')
    .order('created_at', { ascending: false })
    .limit(20);

  if (!sessions || sessions.length === 0) return [];

  // Fetch results for all sessions in one query
  const sessionIds = sessions.map(s => s.id);
  const { data: allResults } = await supabase
    .from('screening_results')
    .select('session_id, program_name, confidence, confidence_label')
    .in('session_id', sessionIds);

  // Group results by session
  const resultsBySession = new Map<string, Array<{ program_name: string; confidence: string; confidence_label: string }>>();
  for (const r of (allResults || [])) {
    const existing = resultsBySession.get(r.session_id) || [];
    existing.push({ program_name: r.program_name, confidence: r.confidence, confidence_label: r.confidence_label });
    resultsBySession.set(r.session_id, existing);
  }

  return sessions.map(session => ({
    id: session.id,
    answers: session.answers,
    role: session.role,
    status: session.status,
    created_at: session.created_at,
    results: resultsBySession.get(session.id) || [],
  }));
}

export async function getUserBookmarkCount(userId: string): Promise<number> {
  const supabase = await createClient();
  const { count } = await supabase
    .from('bookmarks')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId);
  return count || 0;
}

export async function getActionItemProgress(userId: string): Promise<{ total: number; completed: number }> {
  const supabase = await createClient();

  const { data } = await supabase
    .from('action_items')
    .select('is_completed')
    .eq('user_id', userId);

  if (!data) return { total: 0, completed: 0 };

  return {
    total: data.length,
    completed: data.filter(item => item.is_completed).length,
  };
}
```

**2. Create `src/app/dashboard/layout.tsx`:**
Simple layout that checks for auth and redirects to /login if not authenticated:
```typescript
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import type { ReactNode } from 'react';

export default async function DashboardLayout({ children }: { children: ReactNode }) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login?next=/dashboard');
  }

  return <>{children}</>;
}
```

**3. Create `src/app/dashboard/page.tsx`:**
Server Component that displays:
- Welcome message with user email
- Quick stats cards: total screenings, bookmarks saved, action item progress
- Screening history section: list of past screenings as cards showing date, role, number of matched programs with confidence breakdown, and "View Results" link to /screening/results/[sessionId]
- Empty states: "No screenings yet — Start your first screening" with link to /screening
- Bookmarks section: placeholder count with "View Bookmarks" link (will be wired in Plan 03)
- Action items section: progress bar + count with "View Action Items" link (will be wired in Plan 03)

Use existing shadcn/ui components: Card, CardHeader, CardTitle, CardContent, Badge, Button, Separator.
Use lucide-react icons: ClipboardList, Bookmark, CheckCircle, ArrowRight.

Page metadata: title "Your Dashboard | Veteran Resource Management"

For each screening history card:
- Format date: `new Date(entry.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })`
- Show role badge (Veteran or Caregiver)
- List matched program names grouped by confidence with colored badges
- "View Results" link button to `/screening/results/${entry.id}`

Action items progress bar: `(completed / total) * 100` width with green fill and "X of Y complete" text.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Dashboard layout redirects unauthenticated users to /login
3. Dashboard page imports and uses getScreeningHistory, getUserBookmarkCount, getActionItemProgress
4. Screening history cards display date, role, and matched programs
5. Empty state shows when no screenings exist
6. Progress bar renders for action items
  </verify>
  <done>
Dashboard page shows screening history with dates, role, and matched programs grouped by confidence. Quick stats show total screenings, bookmarks count, and action item progress. Auth guard in layout redirects guests to login. All data fetched server-side.
  </done>
</task>

<task type="auto">
  <name>Task 2: Save Results CTA and Header navigation update</name>
  <files>src/components/screening/SaveResultsCTA.tsx, src/app/screening/results/[sessionId]/page.tsx, src/components/layout/Header.tsx</files>
  <action>
**1. Create `src/components/screening/SaveResultsCTA.tsx`:**
Client component that shows a CTA to save screening results to an account.

Props: `{ sessionId: string; isLoggedIn: boolean; isAlreadyClaimed: boolean }`

Behavior:
- If `isAlreadyClaimed` (session already has user_id): show "Results saved to your account" with green checkmark and "Go to Dashboard" link
- If `isLoggedIn` but not claimed: show "Save to My Account" button that calls `claimGuestSession(sessionId)` and `createActionItemsFromResults(sessionId)` server actions, shows loading state, then success confirmation with "Go to Dashboard" link
- If not logged in: show card with heading "Save Your Results", description "Create a free account to save your screening results, track action steps, and bookmark resources.", and two buttons: "Sign Up to Save" linking to `/signup?next=/dashboard&sessionId=${sessionId}` and "Log In" linking to `/login?next=/screening/results/${sessionId}`
- Use shadcn Card component with a subtle blue/green gradient or background
- Use lucide-react icons: Save, LogIn, UserPlus

**2. Update `src/app/screening/results/[sessionId]/page.tsx`:**
Add the SaveResultsCTA component to the results page. Position it between the results sections and the existing action buttons (before the PDF download and "Start New Screening" buttons).

In the server component, determine:
- `isLoggedIn`: check if user exists from supabase.auth.getUser()
- `isAlreadyClaimed`: check if session.user_id is not null

Pass these along with sessionId to SaveResultsCTA.

Import at top: `import { SaveResultsCTA } from '@/components/screening/SaveResultsCTA';`

Add after the last ResultsSection and before the Separator before actions:
```tsx
<SaveResultsCTA
  sessionId={sessionId}
  isLoggedIn={!!user}
  isAlreadyClaimed={session.user_id !== null}
/>
```

Note: The `user` variable already exists in the page from `supabase.auth.getUser()` — currently only used inside the submitScreening flow. Move it to the page level if not already there. Actually, looking at the existing code, the page fetches session data but does not fetch user. Add:
```typescript
const { data: { user } } = await supabase.auth.getUser();
```
After the supabase client creation.

**3. Update `src/components/layout/Header.tsx`:**
Add "Dashboard" link to navigation when user is logged in. In the `{user ? ( ... ) : ( ... )}` conditional:
- Add a "Dashboard" link before the user email display:
```tsx
<li>
  <Link
    href="/dashboard"
    className="hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 rounded"
  >
    Dashboard
  </Link>
</li>
```
This goes inside the `user` truthy branch, before the `<li className="text-sm text-gray-600">{user.email}</li>`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. SaveResultsCTA renders different states based on login/claimed status
3. Results page includes SaveResultsCTA with correct props
4. Header shows Dashboard link when user is authenticated
5. Header does NOT show Dashboard link when user is not authenticated
  </verify>
  <done>
SaveResultsCTA component shows appropriate state (save prompt for guests, claim button for logged-in users, confirmation for already-claimed). Results page includes CTA between results and action buttons. Header navigation includes Dashboard link for authenticated users.
  </done>
</task>

</tasks>

<verification>
1. Dashboard accessible at /dashboard when logged in
2. Dashboard shows screening history with dates and matched programs
3. Dashboard redirects to /login when not authenticated
4. Screening results page shows "Save to Account" CTA for guests
5. Header shows Dashboard link for authenticated users
6. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Authenticated user can visit /dashboard and see screening history with dates, roles, and program matches
- Guest user on screening results page sees "Sign Up to Save" CTA
- Logged-in user on screening results page can claim guest session with one click
- Dashboard shows quick stats for screenings, bookmarks, and action items
- Header navigation updated with Dashboard link for logged-in users
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-accounts-dashboard/05-02-SUMMARY.md`
</output>
